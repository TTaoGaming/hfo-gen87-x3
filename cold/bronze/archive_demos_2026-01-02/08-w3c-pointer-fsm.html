<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>W3C Pointer Events Level 3 - FSM Visualizer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-dim: #8b949e;
      --accent: #58a6ff;
      
      /* W3C Pointer Event Colors */
      --pointermove: #3fb950;
      --pointerdown: #f85149;
      --pointerup: #58a6ff;
      --pointercancel: #f0883e;
      --pointerenter: #a371f7;
      --pointerleave: #8b949e;
      
      /* FSM State Colors */
      --state-disarmed: #484f58;
      --state-arming: #f0883e;
      --state-armed: #3fb950;
      --state-down-commit: #f85149;
      --state-down-nav: #a371f7;
      --state-zoom: #58a6ff;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    h1 .badge {
      font-size: 0.75rem;
      background: var(--accent);
      color: var(--bg);
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .subtitle {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 1200px) {
      .grid { grid-template-columns: 1fr; }
    }
    
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    
    .panel h2 {
      font-size: 1rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel h2 .icon { font-size: 1.2rem; }
    
    /* FSM Diagram */
    .fsm-diagram {
      position: relative;
      height: 400px;
      background: var(--bg);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .fsm-diagram svg {
      width: 100%;
      height: 100%;
    }
    
    .state-node {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .state-node:hover { opacity: 0.8; }
    
    .state-node.active rect,
    .state-node.active ellipse {
      stroke-width: 3;
      filter: drop-shadow(0 0 8px currentColor);
    }
    
    .state-label {
      font-family: monospace;
      font-size: 12px;
      font-weight: 600;
      fill: white;
    }
    
    .state-w3c {
      font-family: monospace;
      font-size: 9px;
      fill: rgba(255,255,255,0.7);
    }
    
    .transition-line {
      fill: none;
      stroke: var(--border);
      stroke-width: 1.5;
      marker-end: url(#arrowhead);
    }
    
    .transition-line.active {
      stroke: var(--accent);
      stroke-width: 2;
      animation: pulse 0.5s ease-out;
    }
    
    @keyframes pulse {
      0% { stroke-width: 4; opacity: 1; }
      100% { stroke-width: 2; opacity: 1; }
    }
    
    .transition-label {
      font-family: monospace;
      font-size: 8px;
      fill: var(--text-dim);
    }
    
    /* W3C Mapping Table */
    .mapping-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    
    .mapping-table th,
    .mapping-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .mapping-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.5px;
    }
    
    .mapping-table tr:hover {
      background: rgba(88, 166, 255, 0.05);
    }
    
    .mapping-table tr.active {
      background: rgba(88, 166, 255, 0.15);
    }
    
    .w3c-event {
      font-family: monospace;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 0.8rem;
    }
    
    .w3c-event.pointermove { background: rgba(63, 185, 80, 0.2); color: var(--pointermove); }
    .w3c-event.pointerdown { background: rgba(248, 81, 73, 0.2); color: var(--pointerdown); }
    .w3c-event.pointerup { background: rgba(88, 166, 255, 0.2); color: var(--pointerup); }
    .w3c-event.pointercancel { background: rgba(240, 136, 62, 0.2); color: var(--pointercancel); }
    
    /* Event Log */
    .event-log {
      height: 300px;
      overflow-y: auto;
      background: var(--bg);
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.8rem;
    }
    
    .event-log-entry {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .event-log-entry:last-child { border-bottom: none; }
    
    .event-log-entry .time {
      color: var(--text-dim);
      font-size: 0.7rem;
      min-width: 60px;
    }
    
    .event-log-entry .event-type {
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      min-width: 100px;
    }
    
    .event-log-entry .coords {
      color: var(--text-dim);
    }
    
    .event-log-entry .transition {
      color: var(--accent);
      font-size: 0.75rem;
    }
    
    /* Current State Display */
    .current-state {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 16px;
    }
    
    .state-badge {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: monospace;
      padding: 12px 24px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .state-badge[data-state="DISARMED"] { background: var(--state-disarmed); }
    .state-badge[data-state="ARMING"] { background: var(--state-arming); color: var(--bg); }
    .state-badge[data-state="ARMED"] { background: var(--state-armed); color: var(--bg); }
    .state-badge[data-state="DOWN_COMMIT"] { background: var(--state-down-commit); }
    .state-badge[data-state="DOWN_NAV"] { background: var(--state-down-nav); }
    .state-badge[data-state="ZOOM"] { background: var(--state-zoom); color: var(--bg); }
    
    .w3c-badge {
      font-size: 1rem;
      color: var(--text-dim);
    }
    
    .w3c-badge .event {
      font-family: monospace;
      font-weight: 600;
    }
    
    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .controls button {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .controls button:hover {
      background: var(--bg);
      border-color: var(--accent);
    }
    
    .controls button.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    
    /* Gesture Legend */
    .gesture-legend {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }
    
    .gesture-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 4px;
      font-size: 0.85rem;
    }
    
    .gesture-item .emoji { font-size: 1.2rem; }
    
    /* W3C Spec Reference */
    .spec-ref {
      margin-top: 20px;
      padding: 16px;
      background: rgba(88, 166, 255, 0.1);
      border: 1px solid rgba(88, 166, 255, 0.3);
      border-radius: 6px;
      font-size: 0.85rem;
    }
    
    .spec-ref h3 {
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--accent);
    }
    
    .spec-ref code {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8rem;
    }
    
    .spec-ref ul {
      margin-left: 20px;
      margin-top: 8px;
    }
    
    .spec-ref li {
      margin-bottom: 4px;
      color: var(--text-dim);
    }
  </style>
</head>
<body>
  <h1>
    W3C Pointer Events Level 3
    <span class="badge">FSM Visualizer</span>
  </h1>
  <p class="subtitle">
    MediaPipe Hand Gestures ‚Üí FSM State Machine ‚Üí W3C PointerEvent Emission
  </p>
  
  <div class="grid">
    <!-- FSM State Diagram -->
    <div class="panel">
      <h2><span class="icon">üîÑ</span> FSM State Machine</h2>
      
      <div class="current-state">
        <div class="state-badge" id="currentState" data-state="DISARMED">DISARMED</div>
        <div class="w3c-badge">
          ‚Üí <span class="event" id="currentW3CEvent">none</span>
        </div>
      </div>
      
      <div class="fsm-diagram">
        <svg viewBox="0 0 600 380">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="var(--border)" />
            </marker>
            <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent)" />
            </marker>
          </defs>
          
          <!-- Transitions -->
          <g id="transitions">
            <!-- DISARMED ‚Üí ARMING -->
            <path class="transition-line" id="t-disarmed-arming" d="M 120 90 Q 180 60 240 90" />
            <text class="transition-label" x="180" y="55">Open_Palm</text>
            
            <!-- ARMING ‚Üí DISARMED -->
            <path class="transition-line" id="t-arming-disarmed" d="M 240 110 Q 180 140 120 110" />
            <text class="transition-label" x="180" y="145">!baseline</text>
            
            <!-- ARMING ‚Üí ARMED -->
            <path class="transition-line" id="t-arming-armed" d="M 300 100 L 380 100" />
            <text class="transition-label" x="335" y="90">stable 200ms</text>
            
            <!-- ARMED ‚Üí DISARMED -->
            <path class="transition-line" id="t-armed-disarmed" d="M 450 70 Q 300 20 80 70" />
            <text class="transition-label" x="250" y="25">!tracking || !palmFacing</text>
            
            <!-- ARMED ‚Üí DOWN_COMMIT -->
            <path class="transition-line" id="t-armed-down_commit" d="M 450 130 L 450 200" />
            <text class="transition-label" x="460" y="165">Pointing_Up</text>
            
            <!-- DOWN_COMMIT ‚Üí ARMED -->
            <path class="transition-line" id="t-down_commit-armed" d="M 420 200 L 420 130" />
            <text class="transition-label" x="370" y="165">Open_Palm</text>
            
            <!-- DOWN_COMMIT ‚Üí DISARMED -->
            <path class="transition-line" id="t-down_commit-disarmed" d="M 380 240 Q 200 280 80 130" />
            <text class="transition-label" x="200" y="260">!tracking</text>
            
            <!-- ARMED ‚Üí DOWN_NAV -->
            <path class="transition-line" id="t-armed-down_nav" d="M 520 130 L 550 200" />
            <text class="transition-label" x="540" y="165">Victory</text>
            
            <!-- DOWN_NAV ‚Üí ARMED -->
            <path class="transition-line" id="t-down_nav-armed" d="M 520 200 L 490 130" />
            
            <!-- ARMED ‚Üí ZOOM -->
            <path class="transition-line" id="t-armed-zoom" d="M 450 130 L 300 220" />
            <text class="transition-label" x="355" y="185">Thumb_Up/Down</text>
            
            <!-- ZOOM ‚Üí ARMED -->
            <path class="transition-line" id="t-zoom-armed" d="M 300 200 L 410 130" />
          </g>
          
          <!-- States -->
          <g id="states">
            <!-- DISARMED -->
            <g class="state-node" id="state-DISARMED" transform="translate(80, 100)">
              <ellipse cx="0" cy="0" rx="55" ry="30" fill="var(--state-disarmed)" stroke="var(--state-disarmed)" stroke-width="2" />
              <text class="state-label" x="0" y="-5" text-anchor="middle">DISARMED</text>
              <text class="state-w3c" x="0" y="10" text-anchor="middle">none</text>
            </g>
            
            <!-- ARMING -->
            <g class="state-node" id="state-ARMING" transform="translate(270, 100)">
              <rect x="-50" y="-25" width="100" height="50" rx="6" fill="var(--state-arming)" stroke="var(--state-arming)" stroke-width="2" />
              <text class="state-label" x="0" y="-5" text-anchor="middle">ARMING</text>
              <text class="state-w3c" x="0" y="10" text-anchor="middle">none (wait)</text>
            </g>
            
            <!-- ARMED -->
            <g class="state-node" id="state-ARMED" transform="translate(450, 100)">
              <rect x="-55" y="-30" width="110" height="60" rx="8" fill="var(--state-armed)" stroke="var(--state-armed)" stroke-width="2" />
              <text class="state-label" x="0" y="-8" text-anchor="middle">ARMED</text>
              <text class="state-w3c" x="0" y="8" text-anchor="middle">pointermove</text>
            </g>
            
            <!-- DOWN_COMMIT (Primary Click) -->
            <g class="state-node" id="state-DOWN_COMMIT" transform="translate(450, 240)">
              <rect x="-65" y="-30" width="130" height="60" rx="8" fill="var(--state-down-commit)" stroke="var(--state-down-commit)" stroke-width="2" />
              <text class="state-label" x="0" y="-8" text-anchor="middle">DOWN_COMMIT</text>
              <text class="state-w3c" x="0" y="8" text-anchor="middle">pointerdown(0)</text>
            </g>
            
            <!-- DOWN_NAV (Middle Click) -->
            <g class="state-node" id="state-DOWN_NAV" transform="translate(550, 240)">
              <rect x="-55" y="-25" width="110" height="50" rx="6" fill="var(--state-down-nav)" stroke="var(--state-down-nav)" stroke-width="2" />
              <text class="state-label" x="0" y="-5" text-anchor="middle">DOWN_NAV</text>
              <text class="state-w3c" x="0" y="10" text-anchor="middle">pointerdown(1)</text>
            </g>
            
            <!-- ZOOM -->
            <g class="state-node" id="state-ZOOM" transform="translate(280, 240)">
              <rect x="-45" y="-25" width="90" height="50" rx="6" fill="var(--state-zoom)" stroke="var(--state-zoom)" stroke-width="2" />
              <text class="state-label" x="0" y="-5" text-anchor="middle">ZOOM</text>
              <text class="state-w3c" x="0" y="10" text-anchor="middle">wheel(ctrl)</text>
            </g>
          </g>
          
          <!-- W3C Event Emissions Legend -->
          <g transform="translate(20, 320)">
            <text fill="var(--text-dim)" font-size="10" font-weight="600">W3C POINTER EVENTS:</text>
            <g transform="translate(0, 15)">
              <rect x="0" y="0" width="10" height="10" fill="var(--pointermove)" rx="2" />
              <text fill="var(--text-dim)" font-size="9" x="15" y="9">pointermove</text>
              
              <rect x="90" y="0" width="10" height="10" fill="var(--pointerdown)" rx="2" />
              <text fill="var(--text-dim)" font-size="9" x="105" y="9">pointerdown</text>
              
              <rect x="180" y="0" width="10" height="10" fill="var(--pointerup)" rx="2" />
              <text fill="var(--text-dim)" font-size="9" x="195" y="9">pointerup</text>
              
              <rect x="255" y="0" width="10" height="10" fill="var(--pointercancel)" rx="2" />
              <text fill="var(--text-dim)" font-size="9" x="270" y="9">pointercancel</text>
            </g>
          </g>
        </svg>
      </div>
      
      <div class="gesture-legend">
        <div class="gesture-item"><span class="emoji">‚úã</span> Open_Palm ‚Üí ARMED</div>
        <div class="gesture-item"><span class="emoji">‚òùÔ∏è</span> Pointing_Up ‚Üí Click</div>
        <div class="gesture-item"><span class="emoji">‚úåÔ∏è</span> Victory ‚Üí Pan</div>
        <div class="gesture-item"><span class="emoji">üëç</span> Thumb_Up ‚Üí Zoom In</div>
        <div class="gesture-item"><span class="emoji">üëé</span> Thumb_Down ‚Üí Zoom Out</div>
      </div>
    </div>
    
    <!-- W3C Mapping & Event Log -->
    <div class="panel">
      <h2><span class="icon">üìã</span> W3C PointerEvent Mapping</h2>
      
      <table class="mapping-table">
        <thead>
          <tr>
            <th>FSM Transition</th>
            <th>W3C Event</th>
            <th>Properties</th>
          </tr>
        </thead>
        <tbody id="mappingTableBody">
          <tr data-transition="enter-armed">
            <td>‚Üí ARMED</td>
            <td><span class="w3c-event pointermove">pointermove</span></td>
            <td><code>pointerType: "hand"</code></td>
          </tr>
          <tr data-transition="armed-move">
            <td>ARMED (move)</td>
            <td><span class="w3c-event pointermove">pointermove</span></td>
            <td><code>clientX, clientY, pressure: 0</code></td>
          </tr>
          <tr data-transition="enter-down_commit">
            <td>‚Üí DOWN_COMMIT</td>
            <td><span class="w3c-event pointerdown">pointerdown</span></td>
            <td><code>button: 0, buttons: 1</code></td>
          </tr>
          <tr data-transition="exit-down_commit">
            <td>DOWN_COMMIT ‚Üí</td>
            <td><span class="w3c-event pointerup">pointerup</span></td>
            <td><code>button: 0, buttons: 0</code></td>
          </tr>
          <tr data-transition="enter-down_nav">
            <td>‚Üí DOWN_NAV</td>
            <td><span class="w3c-event pointerdown">pointerdown</span></td>
            <td><code>button: 1, buttons: 4</code></td>
          </tr>
          <tr data-transition="exit-down_nav">
            <td>DOWN_NAV ‚Üí</td>
            <td><span class="w3c-event pointerup">pointerup</span></td>
            <td><code>button: 1, buttons: 0</code></td>
          </tr>
          <tr data-transition="tracking-lost">
            <td>!tracking</td>
            <td><span class="w3c-event pointercancel">pointercancel</span></td>
            <td><code>Abnormal termination</code></td>
          </tr>
          <tr data-transition="zoom">
            <td>ZOOM</td>
            <td><span class="w3c-event" style="background: rgba(88, 166, 255, 0.2); color: var(--state-zoom);">wheel</span></td>
            <td><code>deltaY: ¬±100, ctrlKey: true</code></td>
          </tr>
        </tbody>
      </table>
      
      <div class="spec-ref">
        <h3>W3C Pointer Events Level 3 Alignment</h3>
        <ul>
          <li><code>pointerId</code> = unique per hand (multi-hand support)</li>
          <li><code>pointerType</code> = "hand" (custom, like "pen")</li>
          <li><code>isPrimary</code> = true for dominant hand</li>
          <li><code>getCoalescedEvents()</code> ‚Üí high-freq MediaPipe frames</li>
          <li><code>getPredictedEvents()</code> ‚Üí Rapier physics prediction</li>
          <li><code>pressure</code> = confidence (0.0 - 1.0)</li>
        </ul>
      </div>
    </div>
  </div>
  
  <!-- Simulation Controls -->
  <div class="panel">
    <h2><span class="icon">üéÆ</span> FSM Simulation</h2>
    
    <div class="controls">
      <button id="btnOpenPalm" data-gesture="Open_Palm">‚úã Open Palm</button>
      <button id="btnPointingUp" data-gesture="Pointing_Up">‚òùÔ∏è Pointing Up</button>
      <button id="btnVictory" data-gesture="Victory">‚úåÔ∏è Victory</button>
      <button id="btnThumbUp" data-gesture="Thumb_Up">üëç Thumb Up</button>
      <button id="btnThumbDown" data-gesture="Thumb_Down">üëé Thumb Down</button>
      <button id="btnNone" data-gesture="None">‚ùå None (Lost)</button>
      <button id="btnReset" style="margin-left: auto; border-color: var(--pointercancel);">üîÑ Reset</button>
    </div>
    
    <div class="event-log" id="eventLog">
      <div class="event-log-entry">
        <span class="time">00:00.000</span>
        <span class="event-type" style="background: var(--state-disarmed);">INIT</span>
        <span class="coords">FSM initialized in DISARMED state</span>
      </div>
    </div>
  </div>
  
  <script>
    // =========================================================================
    // W3C Pointer Events Level 3 - FSM State Machine
    // =========================================================================
    // This visualizer demonstrates how MediaPipe hand gestures map to
    // W3C PointerEvent emissions through a finite state machine.
    //
    // W3C Spec: https://www.w3.org/TR/pointerevents3/
    // =========================================================================
    
    /**
     * W3C PointerEvent Types (Level 3)
     * @see https://www.w3.org/TR/pointerevents3/#the-pointerevent-interface
     */
    const W3C_POINTER_EVENTS = {
      POINTER_MOVE: 'pointermove',      // Cursor movement
      POINTER_DOWN: 'pointerdown',      // Button press
      POINTER_UP: 'pointerup',          // Button release  
      POINTER_CANCEL: 'pointercancel',  // Abnormal termination
      POINTER_ENTER: 'pointerenter',    // Enter target
      POINTER_LEAVE: 'pointerleave',    // Leave target
    };
    
    /**
     * W3C Mouse Button Values
     * @see https://www.w3.org/TR/pointerevents3/#button-states
     */
    const W3C_BUTTON = {
      PRIMARY: 0,     // Left click (Pointing_Up gesture)
      AUXILIARY: 1,   // Middle click (Victory gesture for pan)
      SECONDARY: 2,   // Right click (not mapped)
    };
    
    /**
     * FSM States with W3C Event Mappings
     */
    const FSM_STATES = {
      DISARMED: {
        name: 'DISARMED',
        w3cOnEnter: null,           // No event on enter
        w3cDuring: null,            // No events while in state
        description: 'System inactive - no pointer events emitted'
      },
      ARMING: {
        name: 'ARMING',
        w3cOnEnter: null,           // No event - waiting for stability
        w3cDuring: null,
        description: 'Waiting for stable Open_Palm baseline (200ms)'
      },
      ARMED: {
        name: 'ARMED',
        w3cOnEnter: W3C_POINTER_EVENTS.POINTER_MOVE,  // First move
        w3cDuring: W3C_POINTER_EVENTS.POINTER_MOVE,   // Continuous tracking
        description: 'Cursor active - emitting pointermove'
      },
      DOWN_COMMIT: {
        name: 'DOWN_COMMIT',
        w3cOnEnter: W3C_POINTER_EVENTS.POINTER_DOWN,  // button: 0
        w3cOnExit: W3C_POINTER_EVENTS.POINTER_UP,     // button: 0
        w3cDuring: W3C_POINTER_EVENTS.POINTER_MOVE,   // Drag
        button: W3C_BUTTON.PRIMARY,
        description: 'Primary click/drag (button=0)'
      },
      DOWN_NAV: {
        name: 'DOWN_NAV',
        w3cOnEnter: W3C_POINTER_EVENTS.POINTER_DOWN,  // button: 1
        w3cOnExit: W3C_POINTER_EVENTS.POINTER_UP,     // button: 1
        w3cDuring: W3C_POINTER_EVENTS.POINTER_MOVE,
        button: W3C_BUTTON.AUXILIARY,
        description: 'Pan mode (middle button=1)'
      },
      ZOOM: {
        name: 'ZOOM',
        w3cOnEnter: 'wheel',         // wheel event with ctrlKey
        w3cDuring: 'wheel',
        description: 'Zoom via wheel event (ctrlKey: true)'
      }
    };
    
    /**
     * MediaPipe Gesture ‚Üí FSM Transition Mapping
     */
    const GESTURE_TRANSITIONS = {
      'Open_Palm': {
        from: ['DISARMED'],
        to: 'ARMING',
        w3cEvent: null,
      },
      'Open_Palm_Stable': {
        from: ['ARMING'],
        to: 'ARMED',
        w3cEvent: W3C_POINTER_EVENTS.POINTER_MOVE,
      },
      'Pointing_Up': {
        from: ['ARMED'],
        to: 'DOWN_COMMIT',
        w3cEvent: W3C_POINTER_EVENTS.POINTER_DOWN,
        w3cButton: W3C_BUTTON.PRIMARY,
      },
      'Victory': {
        from: ['ARMED'],
        to: 'DOWN_NAV',
        w3cEvent: W3C_POINTER_EVENTS.POINTER_DOWN,
        w3cButton: W3C_BUTTON.AUXILIARY,
      },
      'Thumb_Up': {
        from: ['ARMED'],
        to: 'ZOOM',
        w3cEvent: 'wheel',
        w3cDeltaY: -100,  // Zoom in
      },
      'Thumb_Down': {
        from: ['ARMED'],
        to: 'ZOOM',
        w3cEvent: 'wheel',
        w3cDeltaY: 100,   // Zoom out
      },
      'None': {
        from: ['ARMING', 'ARMED', 'DOWN_COMMIT', 'DOWN_NAV', 'ZOOM'],
        to: 'DISARMED',
        w3cEvent: W3C_POINTER_EVENTS.POINTER_CANCEL,
      }
    };
    
    // =========================================================================
    // FSM Engine
    // =========================================================================
    
    class W3CPointerFSM {
      constructor() {
        this.state = 'DISARMED';
        this.armingStartTime = null;
        this.ARM_STABLE_MS = 200;
        this.position = { x: 0.5, y: 0.5 };
        this.pointerId = 1;  // W3C: unique pointer ID
        this.listeners = [];
      }
      
      /**
       * Process a gesture frame and emit W3C events
       * @param {string} gesture - MediaPipe gesture label
       * @param {number} confidence - 0.0-1.0
       * @param {{x: number, y: number}} position - Normalized position
       * @returns {{state: string, w3cEvent: object|null, transition: string}}
       */
      processGesture(gesture, confidence = 0.9, position = null) {
        const previousState = this.state;
        position = position || this.position;
        this.position = position;
        
        let w3cEvent = null;
        let transitionName = null;
        
        // State machine logic
        switch (this.state) {
          case 'DISARMED':
            if (gesture === 'Open_Palm' && confidence >= 0.7) {
              this.state = 'ARMING';
              this.armingStartTime = Date.now();
              transitionName = 'Open_Palm ‚Üí ARMING';
            }
            break;
            
          case 'ARMING':
            if (gesture !== 'Open_Palm' || confidence < 0.7) {
              this.state = 'DISARMED';
              this.armingStartTime = null;
              transitionName = '!baseline ‚Üí DISARMED';
            } else if (Date.now() - this.armingStartTime >= this.ARM_STABLE_MS) {
              this.state = 'ARMED';
              transitionName = 'stable ‚Üí ARMED';
              w3cEvent = this.createPointerMoveEvent(position);
            }
            break;
            
          case 'ARMED':
            if (gesture === 'None' || confidence < 0.5) {
              this.state = 'DISARMED';
              transitionName = '!tracking ‚Üí DISARMED';
              w3cEvent = this.createPointerCancelEvent();
            } else if (gesture === 'Pointing_Up' && confidence >= 0.7) {
              this.state = 'DOWN_COMMIT';
              transitionName = 'Pointing_Up ‚Üí DOWN_COMMIT';
              w3cEvent = this.createPointerDownEvent(W3C_BUTTON.PRIMARY, position);
            } else if (gesture === 'Victory' && confidence >= 0.7) {
              this.state = 'DOWN_NAV';
              transitionName = 'Victory ‚Üí DOWN_NAV';
              w3cEvent = this.createPointerDownEvent(W3C_BUTTON.AUXILIARY, position);
            } else if (gesture === 'Thumb_Up' && confidence >= 0.7) {
              this.state = 'ZOOM';
              transitionName = 'Thumb_Up ‚Üí ZOOM';
              w3cEvent = this.createWheelEvent(-100, position);
            } else if (gesture === 'Thumb_Down' && confidence >= 0.7) {
              this.state = 'ZOOM';
              transitionName = 'Thumb_Down ‚Üí ZOOM';
              w3cEvent = this.createWheelEvent(100, position);
            } else {
              w3cEvent = this.createPointerMoveEvent(position);
            }
            break;
            
          case 'DOWN_COMMIT':
            if (gesture === 'None' || confidence < 0.5) {
              this.state = 'DISARMED';
              transitionName = '!tracking ‚Üí DISARMED (cancel)';
              w3cEvent = this.createPointerCancelEvent();
            } else if (gesture === 'Open_Palm' && confidence >= 0.7) {
              this.state = 'ARMED';
              transitionName = 'Open_Palm ‚Üí ARMED (up)';
              w3cEvent = this.createPointerUpEvent(W3C_BUTTON.PRIMARY, position);
              this.armingStartTime = Date.now();
            } else {
              w3cEvent = this.createPointerMoveEvent(position);
            }
            break;
            
          case 'DOWN_NAV':
            if (gesture === 'None' || confidence < 0.5) {
              this.state = 'DISARMED';
              transitionName = '!tracking ‚Üí DISARMED (cancel)';
              w3cEvent = this.createPointerCancelEvent();
            } else if (gesture === 'Open_Palm' && confidence >= 0.7) {
              this.state = 'ARMED';
              transitionName = 'Open_Palm ‚Üí ARMED (up)';
              w3cEvent = this.createPointerUpEvent(W3C_BUTTON.AUXILIARY, position);
              this.armingStartTime = Date.now();
            } else {
              w3cEvent = this.createPointerMoveEvent(position);
            }
            break;
            
          case 'ZOOM':
            if (gesture === 'None' || confidence < 0.5) {
              this.state = 'DISARMED';
              transitionName = '!tracking ‚Üí DISARMED';
              w3cEvent = this.createPointerCancelEvent();
            } else if (gesture === 'Open_Palm' && confidence >= 0.7) {
              this.state = 'ARMED';
              transitionName = 'Open_Palm ‚Üí ARMED';
              w3cEvent = this.createPointerMoveEvent(position);
              this.armingStartTime = Date.now();
            } else if (gesture === 'Thumb_Up') {
              w3cEvent = this.createWheelEvent(-100, position);
            } else if (gesture === 'Thumb_Down') {
              w3cEvent = this.createWheelEvent(100, position);
            }
            break;
        }
        
        const result = {
          previousState,
          state: this.state,
          w3cEvent,
          transition: transitionName,
        };
        
        this.notify(result);
        return result;
      }
      
      // W3C PointerEvent Factories
      // @see https://www.w3.org/TR/pointerevents3/
      
      createPointerMoveEvent(position) {
        return {
          type: W3C_POINTER_EVENTS.POINTER_MOVE,
          pointerId: this.pointerId,
          pointerType: 'hand',  // Custom type like 'pen'
          isPrimary: true,
          clientX: position.x * window.innerWidth,
          clientY: position.y * window.innerHeight,
          pressure: 0,         // No button pressed
          buttons: 0,
          // Level 3: getCoalescedEvents() would return MediaPipe frame history
          // Level 3: getPredictedEvents() would return Rapier predictions
        };
      }
      
      createPointerDownEvent(button, position) {
        return {
          type: W3C_POINTER_EVENTS.POINTER_DOWN,
          pointerId: this.pointerId,
          pointerType: 'hand',
          isPrimary: true,
          button: button,
          buttons: button === 0 ? 1 : (button === 1 ? 4 : 2),
          clientX: position.x * window.innerWidth,
          clientY: position.y * window.innerHeight,
          pressure: 0.5,       // Half pressure on press
        };
      }
      
      createPointerUpEvent(button, position) {
        return {
          type: W3C_POINTER_EVENTS.POINTER_UP,
          pointerId: this.pointerId,
          pointerType: 'hand',
          isPrimary: true,
          button: button,
          buttons: 0,
          clientX: position.x * window.innerWidth,
          clientY: position.y * window.innerHeight,
          pressure: 0,
        };
      }
      
      createPointerCancelEvent() {
        return {
          type: W3C_POINTER_EVENTS.POINTER_CANCEL,
          pointerId: this.pointerId,
          pointerType: 'hand',
          isPrimary: true,
          // Cancel = abnormal termination (tracking lost)
        };
      }
      
      createWheelEvent(deltaY, position) {
        return {
          type: 'wheel',
          deltaY: deltaY,
          deltaMode: 0,        // DOM_DELTA_PIXEL
          ctrlKey: true,       // Indicates zoom (not scroll)
          clientX: position.x * window.innerWidth,
          clientY: position.y * window.innerHeight,
        };
      }
      
      reset() {
        this.state = 'DISARMED';
        this.armingStartTime = null;
        this.notify({ state: 'DISARMED', transition: 'RESET' });
      }
      
      subscribe(callback) {
        this.listeners.push(callback);
        return () => {
          this.listeners = this.listeners.filter(l => l !== callback);
        };
      }
      
      notify(event) {
        this.listeners.forEach(l => l(event));
      }
    }
    
    // =========================================================================
    // UI Visualization
    // =========================================================================
    
    const fsm = new W3CPointerFSM();
    const eventLog = document.getElementById('eventLog');
    const currentStateEl = document.getElementById('currentState');
    const currentW3CEventEl = document.getElementById('currentW3CEvent');
    let startTime = Date.now();
    
    // Subscribe to FSM changes
    fsm.subscribe((event) => {
      updateStateDisplay(event.state);
      updateDiagram(event.previousState, event.state);
      if (event.w3cEvent || event.transition) {
        logEvent(event);
      }
    });
    
    function updateStateDisplay(state) {
      currentStateEl.textContent = state;
      currentStateEl.dataset.state = state;
      
      const stateInfo = FSM_STATES[state];
      if (stateInfo && stateInfo.w3cDuring) {
        currentW3CEventEl.textContent = stateInfo.w3cDuring;
      } else {
        currentW3CEventEl.textContent = 'none';
      }
    }
    
    function updateDiagram(previousState, newState) {
      // Clear all active states
      document.querySelectorAll('.state-node').forEach(el => {
        el.classList.remove('active');
      });
      
      // Highlight current state
      const stateNode = document.getElementById(`state-${newState}`);
      if (stateNode) {
        stateNode.classList.add('active');
      }
      
      // Animate transition line
      if (previousState && previousState !== newState) {
        const transitionId = `t-${previousState.toLowerCase()}-${newState.toLowerCase()}`;
        const transitionLine = document.getElementById(transitionId);
        if (transitionLine) {
          transitionLine.classList.add('active');
          setTimeout(() => transitionLine.classList.remove('active'), 500);
        }
      }
      
      // Highlight mapping table row
      document.querySelectorAll('.mapping-table tr').forEach(tr => {
        tr.classList.remove('active');
      });
    }
    
    function logEvent(event) {
      const elapsed = Date.now() - startTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      const millis = elapsed % 1000;
      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(millis).padStart(3, '0')}`;
      
      const entry = document.createElement('div');
      entry.className = 'event-log-entry';
      
      let eventTypeStyle = 'background: var(--text-dim);';
      let eventTypeText = event.state;
      
      if (event.w3cEvent) {
        switch (event.w3cEvent.type) {
          case 'pointermove':
            eventTypeStyle = 'background: var(--pointermove); color: #000;';
            eventTypeText = 'pointermove';
            break;
          case 'pointerdown':
            eventTypeStyle = 'background: var(--pointerdown);';
            eventTypeText = `pointerdown(${event.w3cEvent.button})`;
            break;
          case 'pointerup':
            eventTypeStyle = 'background: var(--pointerup); color: #000;';
            eventTypeText = `pointerup(${event.w3cEvent.button})`;
            break;
          case 'pointercancel':
            eventTypeStyle = 'background: var(--pointercancel); color: #000;';
            eventTypeText = 'pointercancel';
            break;
          case 'wheel':
            eventTypeStyle = 'background: var(--state-zoom); color: #000;';
            eventTypeText = `wheel(${event.w3cEvent.deltaY > 0 ? '+' : ''}${event.w3cEvent.deltaY})`;
            break;
        }
      }
      
      let coordsStr = '';
      if (event.w3cEvent && event.w3cEvent.clientX !== undefined) {
        coordsStr = `(${Math.round(event.w3cEvent.clientX)}, ${Math.round(event.w3cEvent.clientY)})`;
      }
      
      entry.innerHTML = `
        <span class="time">${timeStr}</span>
        <span class="event-type" style="${eventTypeStyle}">${eventTypeText}</span>
        <span class="coords">${coordsStr}</span>
        ${event.transition ? `<span class="transition">${event.transition}</span>` : ''}
      `;
      
      eventLog.appendChild(entry);
      eventLog.scrollTop = eventLog.scrollHeight;
    }
    
    // Button handlers
    document.querySelectorAll('.controls button[data-gesture]').forEach(btn => {
      btn.addEventListener('click', () => {
        const gesture = btn.dataset.gesture;
        
        // Highlight active button
        document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Random position for demo
        const position = {
          x: 0.3 + Math.random() * 0.4,
          y: 0.3 + Math.random() * 0.4
        };
        
        // Special handling for ARMING ‚Üí ARMED (need stable time)
        if (gesture === 'Open_Palm' && fsm.state === 'ARMING') {
          // Simulate stable baseline
          setTimeout(() => {
            fsm.processGesture('Open_Palm', 0.9, position);
          }, 250);
        } else {
          fsm.processGesture(gesture, 0.9, position);
        }
      });
    });
    
    document.getElementById('btnReset').addEventListener('click', () => {
      fsm.reset();
      eventLog.innerHTML = `
        <div class="event-log-entry">
          <span class="time">00:00.000</span>
          <span class="event-type" style="background: var(--state-disarmed);">RESET</span>
          <span class="coords">FSM reset to DISARMED state</span>
        </div>
      `;
      startTime = Date.now();
      document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
    });
    
    // Initialize
    updateStateDisplay('DISARMED');
    document.getElementById('state-DISARMED').classList.add('active');
    
    console.log('W3C Pointer Events Level 3 - FSM Visualizer loaded');
    console.log('FSM States:', Object.keys(FSM_STATES));
    console.log('W3C Events:', W3C_POINTER_EVENTS);
  </script>
</body>
</html>
