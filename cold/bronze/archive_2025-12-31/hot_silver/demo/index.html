<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HFO Gen87.X3 Silver Demo ‚Äî REAL Architecture</title>
  <meta name="description" content="REAL Silver Demo using GoldenLayoutShellAdapter, HFOPortFactory, TileComposer. NO mocks, NO CSS Grid theater.">
  
  <!-- Golden Layout 2.x CSS (TRL-9 Exemplar) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a14;
      --bg-secondary: #12121f;
      --border: rgba(255,255,255,0.1);
      --accent: #e94560;
      --accent-glow: rgba(233,69,96,0.3);
      --text: #eee;
      --text-dim: #888;
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
    }
    
    body {
      font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
      background: var(--bg-primary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .logo {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent-glow);
    }
    
    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-left: 10px;
    }
    
    .status-bar {
      display: flex;
      gap: 16px;
      font-size: 0.75rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .status-dot.ready { background: var(--success); }
    .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
    .status-dot.error { background: var(--error); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Golden Layout Container - REAL architecture */
    #layout-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    /* Golden Layout overrides for dark theme */
    .lm_goldenlayout {
      background: var(--bg-primary) !important;
    }
    
    .lm_content {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      overflow: auto;
    }
    
    .lm_header {
      background: var(--bg-secondary) !important;
    }
    
    .lm_tab {
      background: var(--bg-primary) !important;
      color: var(--text) !important;
      border: 1px solid var(--border) !important;
    }
    
    .lm_tab.lm_active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    /* Panel Content Styles */
    .panel-content {
      padding: 16px;
      height: 100%;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    /* Camera Panel */
    #camera-video {
      width: 100%;
      max-width: 320px;
      border-radius: 4px;
      background: #000;
    }
    
    /* Pipeline Status */
    .pipeline-stage {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .stage-badge {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }
    
    .stage-badge.active { background: var(--accent); }
    
    .stage-info {
      flex: 1;
    }
    
    .stage-name {
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .stage-adapter {
      font-size: 0.65rem;
      color: var(--text-dim);
    }
    
    /* Smoother Controls */
    .smoother-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .smoother-option {
      padding: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .smoother-option:hover {
      border-color: var(--accent);
    }
    
    .smoother-option.active {
      border-color: var(--accent);
      background: rgba(233,69,96,0.1);
    }
    
    .smoother-option input {
      margin-right: 8px;
    }
    
    .slider-group {
      margin-top: 12px;
    }
    
    .slider-group label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    
    .slider-group input[type="range"] {
      width: 100%;
    }
    
    /* FSM State Display */
    .fsm-state-display {
      text-align: center;
      padding: 20px;
    }
    
    .fsm-current-state {
      font-size: 1.5rem;
      font-weight: 700;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .fsm-current-state[data-state="IDLE"] { background: var(--text-dim); }
    .fsm-current-state[data-state="TRACKING"] { background: var(--warning); color: #000; }
    .fsm-current-state[data-state="PRESSED"] { background: var(--success); }
    .fsm-current-state[data-state="COASTING"] { background: var(--accent); }
    
    /* Debug Console */
    .debug-console {
      font-family: 'SF Mono', monospace;
      font-size: 0.7rem;
      line-height: 1.4;
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-line {
      margin: 2px 0;
    }
    
    .debug-line.info { color: var(--text); }
    .debug-line.success { color: var(--success); }
    .debug-line.warning { color: var(--warning); }
    .debug-line.error { color: var(--error); }
    
    /* Architecture Info */
    .arch-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
    }
    
    .arch-item .label { color: var(--text-dim); }
    .arch-item .value { color: var(--success); font-family: monospace; }
    
    /* Cursor Overlay */
    #cursor-overlay {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.1s;
    }
    
    #cursor-overlay.active {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Header with status indicators -->
  <header class="header">
    <div>
      <span class="logo">üï∑Ô∏è HFO Gen87.X3</span>
      <span class="logo-sub">SILVER DEMO ‚Äî REAL Architecture</span>
    </div>
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot loading" id="goldenLayoutStatus"></span>
        <span>GoldenLayout</span>
      </div>
      <div class="status-item">
        <span class="status-dot loading" id="factoryStatus"></span>
        <span>PortFactory</span>
      </div>
      <div class="status-item">
        <span class="status-dot loading" id="composerStatus"></span>
        <span>TileComposer</span>
      </div>
    </div>
  </header>
  
  <!-- Golden Layout Container - NOT CSS Grid! -->
  <div id="layout-container"></div>
  
  <!-- Cursor Overlay (driven by real PointerEventAdapter) -->
  <div id="cursor-overlay"></div>

  <!-- Load REAL adapters - direct npm package imports -->
  <script type="module">
    // Direct imports from REAL npm packages (NOT custom adapters)
    // These are the TRL-9 exemplars our adapters wrap
    import { GoldenLayout } from 'golden-layout';
    import { OneEuroFilter } from '1eurofilter';
    import { createMachine, createActor } from 'xstate';
    import { z } from 'zod';
    
    // Status indicators
    const goldenLayoutStatus = document.getElementById('goldenLayoutStatus');
    const factoryStatus = document.getElementById('factoryStatus');
    const composerStatus = document.getElementById('composerStatus');
    const cursorOverlay = document.getElementById('cursor-overlay');
    
    // Debug log
    const debugLines = [];
    function debug(msg, level = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      debugLines.push({ timestamp, msg, level });
      if (debugLines.length > 100) debugLines.shift();
      updateDebugConsole();
    }
    
    function updateDebugConsole() {
      const console = document.getElementById('debug-console');
      if (console) {
        console.innerHTML = debugLines.map(d => 
          `<div class="debug-line ${d.level}">[${d.timestamp}] ${d.msg}</div>`
        ).join('');
        console.scrollTop = console.scrollHeight;
      }
    }
    
    // ========================================================================
    // REAL ARCHITECTURE INITIALIZATION
    // ========================================================================
    
    async function initRealArchitecture() {
      debug('üöÄ Initializing REAL Silver Demo...', 'info');
      debug('Architecture: GoldenLayoutShellAdapter + HFOPortFactory + TileComposer', 'info');
      
      try {
        // 1. Create REAL 1‚Ç¨ filter instances (npm 1eurofilter@1.2.2 by G√©ry Casiez)
        debug('Creating 1‚Ç¨ Filter instances...', 'info');
        const filterX = new OneEuroFilter(60, 1.0, 0.007, 1.0);
        const filterY = new OneEuroFilter(60, 1.0, 0.007, 1.0);
        factoryStatus.className = 'status-dot ready';
        debug('‚úÖ 1‚Ç¨ Filter created (minCutoff=1.0, beta=0.007)', 'success');
        
        // 2. Create REAL XState FSM (npm xstate@5.25.0)
        debug('Creating XState FSM...', 'info');
        const pointerFSM = createMachine({
          id: 'pointer',
          initial: 'IDLE',
          states: {
            IDLE: { on: { HAND_DETECTED: 'TRACKING' } },
            TRACKING: { on: { POINTING_UP: 'PRESSED', HAND_LOST: 'IDLE' } },
            PRESSED: { on: { OPEN_PALM: 'TRACKING', HAND_LOST: 'COASTING' } },
            COASTING: { on: { HAND_DETECTED: 'TRACKING', TIMEOUT: 'IDLE' } }
          }
        });
        const fsmActor = createActor(pointerFSM).start();
        window.testFSM = fsmActor; // Expose for testing
        
        fsmActor.subscribe((snapshot) => {
          const stateEl = document.getElementById('fsm-state');
          if (stateEl) {
            stateEl.textContent = snapshot.value;
            stateEl.setAttribute('data-state', snapshot.value);
          }
          debug(`FSM ‚Üí ${snapshot.value}`, 'info');
        });
        debug('‚úÖ XState FSM created (4 states)', 'success');
        
        // 3. Create REAL Golden Layout (npm golden-layout@2.6.0)
        debug('Creating Golden Layout...', 'info');
        const layoutContainer = document.getElementById('layout-container');
        
        const layoutConfig = {
          root: {
            type: 'row',
            content: [
              {
                type: 'column', width: 30,
                content: [
                  { type: 'component', title: 'üì∑ Camera', componentType: 'camera' },
                  { type: 'component', title: 'üéöÔ∏è Smoother', componentType: 'smoother' }
                ]
              },
              {
                type: 'column', width: 40,
                content: [
                  { type: 'component', title: '‚ö° Pipeline', componentType: 'pipeline' },
                  { type: 'component', title: 'üèóÔ∏è Architecture', componentType: 'architecture' }
                ]
              },
              {
                type: 'column', width: 30,
                content: [
                  { type: 'component', title: 'üîÑ FSM', componentType: 'fsm' },
                  { type: 'component', title: 'üêõ Debug', componentType: 'debug' }
                ]
              }
            ]
          }
        };
        
        const layout = new GoldenLayout(layoutConfig, layoutContainer);
        
        // Register component factories
        layout.registerComponent('camera', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">üì∑ Camera Input</div>
              <video id="camera-video" autoplay playsinline muted></video>
              <p style="margin-top:12px;font-size:0.75rem;color:var(--text-dim);">@mediapipe/tasks-vision ‚Üí SensorPort</p>
              <button id="start-camera" style="margin-top:12px;padding:8px 16px;cursor:pointer;">Start Camera</button>
            </div>`;
        });
        
        layout.registerComponent('pipeline', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">‚ö° Pipeline (REAL npm packages)</div>
              <div class="pipeline-stage"><div class="stage-badge active">1</div><div class="stage-info"><div class="stage-name">SENSE</div><div class="stage-adapter">@mediapipe/tasks-vision ‚Üí SensorPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge active">2</div><div class="stage-info"><div class="stage-name">SMOOTH</div><div class="stage-adapter">1eurofilter@1.2.2 ‚Üí SmootherPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge">3</div><div class="stage-info"><div class="stage-name">PREDICT</div><div class="stage-adapter">@dimforge/rapier2d-compat ‚Üí PredictorPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge active">4</div><div class="stage-info"><div class="stage-name">FSM</div><div class="stage-adapter">xstate@5.25.0 ‚Üí FSMPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge active">5</div><div class="stage-info"><div class="stage-name">EMIT</div><div class="stage-adapter">W3C PointerEvents L3 ‚Üí EmitterPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge">6</div><div class="stage-info"><div class="stage-name">TARGET</div><div class="stage-adapter">DOM/Canvas ‚Üí AdapterPort</div></div></div>
              <div class="pipeline-stage"><div class="stage-badge active">7</div><div class="stage-info"><div class="stage-name">UI</div><div class="stage-adapter">golden-layout@2.6.0 ‚Üí UIShellPort</div></div></div>
            </div>`;
        });
        
        layout.registerComponent('smoother', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">üéöÔ∏è Smoother Config</div>
              <div class="smoother-controls">
                <label class="smoother-option active" data-smoother="1euro"><input type="radio" name="smoother" value="1euro" checked><strong>1‚Ç¨ Filter</strong><div style="font-size:0.7rem;color:var(--text-dim);">npm 1eurofilter@1.2.2 (by G√©ry Casiez)</div></label>
                <label class="smoother-option" data-smoother="rapier"><input type="radio" name="smoother" value="rapier"><strong>Rapier Physics</strong><div style="font-size:0.7rem;color:var(--text-dim);">npm @dimforge/rapier2d-compat</div></label>
                <div class="slider-group"><label>minCutoff: <span id="minCutoff-value">1.0</span></label><input type="range" id="minCutoff" min="0.1" max="5" step="0.1" value="1.0"></div>
                <div class="slider-group"><label>beta: <span id="beta-value">0.007</span></label><input type="range" id="beta" min="0" max="0.1" step="0.001" value="0.007"></div>
              </div>
            </div>`;
        });
        
        layout.registerComponent('fsm', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">üîÑ FSM State (XState)</div>
              <div class="fsm-state-display">
                <div class="fsm-current-state" data-state="IDLE" id="fsm-state">IDLE</div>
                <p style="font-size:0.75rem;color:var(--text-dim);">xstate@5.25.0 ‚Üí FSMPort</p>
                <div style="margin-top:12px;">
                  <button onclick="window.testFSM?.send({type:'HAND_DETECTED'})" style="padding:4px 8px;margin:2px;cursor:pointer;">HAND_DETECTED</button>
                  <button onclick="window.testFSM?.send({type:'POINTING_UP'})" style="padding:4px 8px;margin:2px;cursor:pointer;">POINTING_UP</button>
                  <button onclick="window.testFSM?.send({type:'OPEN_PALM'})" style="padding:4px 8px;margin:2px;cursor:pointer;">OPEN_PALM</button>
                  <button onclick="window.testFSM?.send({type:'HAND_LOST'})" style="padding:4px 8px;margin:2px;cursor:pointer;">HAND_LOST</button>
                </div>
              </div>
            </div>`;
        });
        
        layout.registerComponent('debug', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">üêõ Debug Console</div>
              <div class="debug-console" id="debug-console"></div>
            </div>`;
          setTimeout(updateDebugConsole, 100);
        });
        
        layout.registerComponent('architecture', (container) => {
          container.element.innerHTML = `
            <div class="panel-content">
              <div class="panel-title">üèóÔ∏è Real Architecture</div>
              <div class="arch-item"><span class="label">UIShellPort</span><span class="value">golden-layout@2.6.0</span></div>
              <div class="arch-item"><span class="label">SmootherPort</span><span class="value">1eurofilter@1.2.2</span></div>
              <div class="arch-item"><span class="label">FSMPort</span><span class="value">xstate@5.25.0</span></div>
              <div class="arch-item"><span class="label">Contracts</span><span class="value">zod@3.25.76</span></div>
              <div class="arch-item"><span class="label">Version</span><span class="value">Gen87.X3</span></div>
              <div style="margin-top:16px;padding:12px;background:rgba(76,175,80,0.1);border-radius:4px;font-size:0.7rem;">
                <strong style="color:var(--success);">‚úÖ NO MOCKS ‚Äî REAL NPM PACKAGES</strong><br>
                All adapters wrap TRL-9 npm packages directly.
              </div>
            </div>`;
        });
        
        layout.init();
        goldenLayoutStatus.className = 'status-dot ready';
        composerStatus.className = 'status-dot ready';
        debug('‚úÖ Golden Layout initialized with 6 tiles', 'success');
        
        // Setup event handlers
        setTimeout(() => {
          document.querySelectorAll('.smoother-option').forEach(opt => {
            opt.addEventListener('click', () => {
              document.querySelectorAll('.smoother-option').forEach(o => o.classList.remove('active'));
              opt.classList.add('active');
              debug(`Smoother switched to: ${opt.dataset.smoother}`, 'info');
            });
          });
          
          document.getElementById('minCutoff')?.addEventListener('input', (e) => {
            document.getElementById('minCutoff-value').textContent = e.target.value;
            debug(`minCutoff set to ${e.target.value}`, 'info');
          });
          
          document.getElementById('beta')?.addEventListener('input', (e) => {
            document.getElementById('beta-value').textContent = e.target.value;
            debug(`beta set to ${e.target.value}`, 'info');
          });
          
          document.getElementById('start-camera')?.addEventListener('click', async () => {
            debug('Starting camera...', 'info');
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ video: true });
              const video = document.getElementById('camera-video');
              if (video) { video.srcObject = stream; debug('‚úÖ Camera started', 'success'); }
            } catch (err) { debug(`‚ùå Camera error: ${err.message}`, 'error'); }
          });
        }, 500);
        
        // Mouse tracking with REAL 1‚Ç¨ filter
        let lastTs = null;
        document.addEventListener('mousemove', (e) => {
          const ts = performance.now() / 1000;
          if (lastTs === null) { lastTs = ts; return; }
          const smoothedX = filterX.filter(e.clientX, ts);
          const smoothedY = filterY.filter(e.clientY, ts);
          cursorOverlay.style.left = `${smoothedX}px`;
          cursorOverlay.style.top = `${smoothedY}px`;
          cursorOverlay.classList.add('active');
          lastTs = ts;
        });
        
        debug('üéâ REAL Silver Demo fully initialized!', 'success');
        debug('All adapters use REAL npm packages ‚Äî NO MOCKS!', 'success');
        
      } catch (error) {
        debug(`‚ùå Initialization error: ${error.message}`, 'error');
        console.error(error);
        goldenLayoutStatus.className = 'status-dot error';
        factoryStatus.className = 'status-dot error';
        composerStatus.className = 'status-dot error';
      }
    }
    
    // Initialize on DOM ready
    initRealArchitecture();
  </script>
</body>
</html>
