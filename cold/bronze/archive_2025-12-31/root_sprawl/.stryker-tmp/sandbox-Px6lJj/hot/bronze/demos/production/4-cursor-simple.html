<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gen87.X3 â€” 4-Cursor Smoother (Simple)</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --panel: #12121a;
      --border: #2a2a3a;
      --accent: #00ff88;
      --cursor-raw: #ff4444;
      --cursor-euro: #00ff88;
      --cursor-smooth: #4488ff;
      --cursor-predict: #ffaa00;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 1rem;
    }
    h1 { color: var(--accent); font-size: 1.2rem; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; height: calc(100vh - 4rem); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
    .camera-box { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 4px; overflow: hidden; }
    #camera { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #canvas { position: absolute; inset: 0; width: 100%; height: 100%; transform: scaleX(-1); }
    .gesture-badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.8); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem; }
    .cursor-area { position: relative; width: 100%; height: 100%; min-height: 400px; background: #1a1a2e; border-radius: 4px; overflow: hidden; }
    .cursor { position: absolute; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    .cursor.raw { width: 12px; height: 12px; background: var(--cursor-raw); opacity: 0.6; }
    .cursor.euro { width: 14px; height: 14px; background: var(--cursor-euro); }
    .cursor.smooth { width: 18px; height: 18px; background: var(--cursor-smooth); }
    .cursor.predict { width: 22px; height: 22px; background: var(--cursor-predict); }
    .legend { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 0.3rem; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .metrics { margin-top: 1rem; font-size: 0.7rem; }
    .metrics div { margin: 0.2rem 0; }
    .status { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); border-top: 1px solid var(--border); padding: 0.5rem 1rem; font-size: 0.7rem; display: flex; gap: 1rem; }
    .status .good { color: var(--accent); }
    .status .bad { color: var(--cursor-raw); }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Gen87.X3 â€” 4-Cursor Smoother Comparison</h1>
  <div class="grid">
    <div class="panel">
      <div class="camera-box">
        <video id="camera" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="gesture-badge" id="gesture">Waiting...</div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--cursor-raw)"></div>Raw</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cursor-euro)"></div>1â‚¬ Filter</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cursor-smooth)"></div>Rapier Smooth</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cursor-predict)"></div>Rapier Predict</div>
      </div>
      <div class="metrics">
        <div>FPS: <span id="fps">--</span></div>
        <div>Raw Jitter: <span id="jitter-raw" style="color:var(--cursor-raw)">--</span></div>
        <div>1â‚¬ Jitter: <span id="jitter-euro" style="color:var(--cursor-euro)">--</span></div>
        <div>Smooth Jitter: <span id="jitter-smooth" style="color:var(--cursor-smooth)">--</span></div>
        <div>Predict Jitter: <span id="jitter-predict" style="color:var(--cursor-predict)">--</span></div>
      </div>
    </div>
    <div class="panel">
      <div class="cursor-area" id="area">
        <div class="cursor raw" id="c-raw"></div>
        <div class="cursor euro" id="c-euro"></div>
        <div class="cursor smooth" id="c-smooth"></div>
        <div class="cursor predict" id="c-predict"></div>
      </div>
    </div>
  </div>
  <div class="status">
    <span id="s-mp">MediaPipe: Loading...</span>
    <span id="s-rp">Rapier: Loading...</span>
  </div>

  <script type="importmap">
  { "imports": {
    "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/+esm",
    "@dimforge/rapier2d-compat": "https://cdn.jsdelivr.net/npm/@dimforge/rapier2d-compat@0.19.3/+esm",
    "1eurofilter": "https://cdn.jsdelivr.net/npm/1eurofilter@1.2.2/+esm"
  }}
  </script>
  <script type="module">
// @ts-nocheck

    import { GestureRecognizer, FilesetResolver, DrawingUtils } from '@mediapipe/tasks-vision';
    import RAPIER from '@dimforge/rapier2d-compat';
    import { OneEuroFilter } from '1eurofilter';

    const $ = id => document.getElementById(id);
    const camera = $('camera'), canvas = $('canvas'), ctx = canvas.getContext('2d');
    const area = $('area');
    const cursors = { raw: $('c-raw'), euro: $('c-euro'), smooth: $('c-smooth'), predict: $('c-predict') };
    const pos = { raw: {x:.5,y:.5}, euro: {x:.5,y:.5}, smooth: {x:.5,y:.5}, predict: {x:.5,y:.5} };
    let euroX, euroY, rapierWorld, bodySmooth, bodyPredict, gestureRecognizer;
    let lastTime = 0, lastPos = {x:.5,y:.5};
    const jitterHist = { raw:[], euro:[], smooth:[], predict:[] };

    async function init() {
      // 1â‚¬ filters
      euroX = new OneEuroFilter({ frequency: 60, minCutoff: 1.0, beta: 0.007 });
      euroY = new OneEuroFilter({ frequency: 60, minCutoff: 1.0, beta: 0.007 });

      // Rapier
      try {
        await RAPIER.init();
        rapierWorld = new RAPIER.World({ x: 0, y: 0 });
        bodySmooth = rapierWorld.createRigidBody(RAPIER.RigidBodyDesc.dynamic().setTranslation(0.5, 0.5).setLinearDamping(8));
        rapierWorld.createCollider(RAPIER.ColliderDesc.ball(0.01), bodySmooth);
        bodyPredict = rapierWorld.createRigidBody(RAPIER.RigidBodyDesc.dynamic().setTranslation(0.5, 0.5).setLinearDamping(5));
        rapierWorld.createCollider(RAPIER.ColliderDesc.ball(0.01), bodyPredict);
        $('s-rp').textContent = 'Rapier: âœ“'; $('s-rp').classList.add('good');
      } catch(e) { $('s-rp').textContent = 'Rapier: ' + e.message; $('s-rp').classList.add('bad'); }

      // MediaPipe
      try {
        const vision = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm');
        gestureRecognizer = await GestureRecognizer.createFromOptions(vision, {
          baseOptions: { modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task', delegate: 'GPU' },
          runningMode: 'VIDEO', numHands: 1
        });
        $('s-mp').textContent = 'MediaPipe: âœ“'; $('s-mp').classList.add('good');
        startCamera();
      } catch(e) { $('s-mp').textContent = 'MediaPipe: ' + e.message; $('s-mp').classList.add('bad'); }
    }

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
      camera.srcObject = stream;
      camera.onloadedmetadata = () => { canvas.width = camera.videoWidth; canvas.height = camera.videoHeight; loop(); };
    }

    function loop() {
      if (!gestureRecognizer) { requestAnimationFrame(loop); return; }
      const now = performance.now();
      const dt = lastTime ? (now - lastTime) / 1000 : 1/60;
      lastTime = now;
      $('fps').textContent = Math.round(1/dt);

      const results = gestureRecognizer.recognizeForVideo(camera, now);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (results.landmarks?.[0]) {
        const hand = results.landmarks[0];
        new DrawingUtils(ctx).drawLandmarks(hand, { color: '#00ff88', lineWidth: 1 });
        const tip = hand[8]; // index tip
        const rawX = tip.x, rawY = tip.y;
        const gesture = results.gestures?.[0]?.[0]?.categoryName || 'None';
        $('gesture').textContent = gesture;

        // Update positions
        pos.raw = { x: rawX, y: rawY };
        pos.euro = { x: euroX.filter(rawX, now/1000), y: euroY.filter(rawY, now/1000) };

        if (rapierWorld) {
          const STIFF = 400;
          // Smooth
          let p = bodySmooth.translation();
          bodySmooth.applyImpulse({ x: (rawX - p.x) * STIFF * dt, y: (rawY - p.y) * STIFF * dt }, true);
          p = bodySmooth.translation();
          pos.smooth = { x: p.x, y: p.y };
          // Predictive
          let p2 = bodyPredict.translation();
          bodyPredict.applyImpulse({ x: (rawX - p2.x) * STIFF * dt, y: (rawY - p2.y) * STIFF * dt }, true);
          p2 = bodyPredict.translation();
          const v = bodyPredict.linvel();
          pos.predict = { x: p2.x + v.x * 0.05, y: p2.y + v.y * 0.05 };
          rapierWorld.step();
        }

        // Jitter calc
        for (const k of ['raw','euro','smooth','predict']) {
          const j = Math.hypot(pos[k].x - lastPos.x, pos[k].y - lastPos.y) * 1000;
          jitterHist[k].push(j); if (jitterHist[k].length > 30) jitterHist[k].shift();
          $('jitter-' + k).textContent = (jitterHist[k].reduce((a,b)=>a+b,0) / jitterHist[k].length).toFixed(1);
        }
        lastPos = { ...pos.raw };

        // Update cursor DOM
        const rect = area.getBoundingClientRect();
        for (const [k, el] of Object.entries(cursors)) {
          el.style.left = (pos[k].x * rect.width) + 'px';
          el.style.top = (pos[k].y * rect.height) + 'px';
        }
      }
      requestAnimationFrame(loop);
    }

    init();
  
</script>
</body>
</html>
