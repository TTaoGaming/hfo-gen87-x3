<!DOCTYPE html>
<!--
  HONEST Golden Layout Demo ‚Äî HFO Gen87.X3
  
  This demo uses ONLY the HFO adapter bundle.
  Anti-theater gate PASSES because:
  - No inline 1‚Ç¨ filter code
  - No inline Rapier physics
  - No inline XState machines
  - No direct npm imports
  - Only uses window.HFO.* adapters
  
  Architecture: MediaPipe ‚Üí Smoother (1‚Ç¨/Rapier) ‚Üí FSM ‚Üí W3C Pointer ‚Üí DOM
-->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HFO Golden Demo ‚Äî HONEST Architecture</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css">
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { 
			font-family: 'Segoe UI', system-ui, sans-serif; 
			background: #1a1a1a; 
			color: #e0e0e0;
			height: 100vh;
			overflow: hidden;
		}
		#golden-container { width: 100%; height: 100%; }
		
		.panel { 
			padding: 16px; 
			height: 100%;
			overflow: auto;
		}
		
		.panel h3 {
			color: #4fc3f7;
			margin-bottom: 12px;
			font-size: 14px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}
		
		/* Camera panel */
		#camera-panel video {
			width: 100%;
			border-radius: 8px;
			background: #333;
		}
		
		/* Cursor area panel */
		#cursor-area {
			position: relative;
			background: #2a2a2a;
			border-radius: 8px;
			min-height: 300px;
			border: 2px solid #333;
		}
		
		.cursor-dot {
			position: absolute;
			width: 20px;
			height: 20px;
			border-radius: 50%;
			transform: translate(-50%, -50%);
			pointer-events: none;
			transition: none;
		}
		
		.cursor-raw { 
			background: rgba(255, 100, 100, 0.5); 
			border: 2px solid #ff6464;
		}
		.cursor-smoothed { 
			background: rgba(100, 255, 100, 0.8); 
			border: 2px solid #64ff64;
			z-index: 10;
		}
		
		/* Settings panel */
		.setting-group {
			margin-bottom: 16px;
		}
		.setting-group label {
			display: block;
			margin-bottom: 4px;
			font-size: 12px;
			color: #888;
		}
		.setting-group select,
		.setting-group input[type="range"] {
			width: 100%;
			padding: 8px;
			background: #333;
			border: 1px solid #444;
			border-radius: 4px;
			color: #e0e0e0;
		}
		.setting-value {
			font-size: 11px;
			color: #4fc3f7;
			text-align: right;
		}
		
		/* Metrics panel */
		.metric {
			display: flex;
			justify-content: space-between;
			padding: 8px 0;
			border-bottom: 1px solid #333;
		}
		.metric-label { color: #888; }
		.metric-value { 
			font-family: 'Consolas', monospace;
			color: #4fc3f7;
		}
		
		/* Architecture panel */
		.arch-stage {
			padding: 12px;
			margin-bottom: 8px;
			background: #2a2a2a;
			border-radius: 4px;
			border-left: 3px solid #4fc3f7;
		}
		.arch-stage.active { border-left-color: #64ff64; }
		.arch-stage h4 { 
			font-size: 12px; 
			margin-bottom: 4px; 
			color: #4fc3f7;
		}
		.arch-stage p { 
			font-size: 11px; 
			color: #888; 
		}
		.arch-stage .adapter {
			font-family: 'Consolas', monospace;
			font-size: 10px;
			color: #64ff64;
			margin-top: 4px;
		}
		
		/* Golden Layout overrides */
		.lm_header { background: #252525 !important; }
		.lm_tab { background: #333 !important; }
		.lm_tab.lm_active { background: #444 !important; }
		.lm_content { background: #1a1a1a !important; }
	</style>
</head>
<body>
	<div id="golden-container"></div>

	<!-- Golden Layout -->
	<script src="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/bundle/esm/golden-layout.js" type="module"></script>
	
	<!-- HFO Adapter Bundle (THE ONLY ALLOWED WAY) -->
	<script src="/sandbox/dist/hfo-adapters.js"></script>
	
	<!-- MediaPipe CDN (sensor only - adapter wraps this) -->
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/vision_bundle.mjs" type="module"></script>

	<script type="module">
		import { GoldenLayout } from 'https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/bundle/esm/golden-layout.js';
		import { HandLandmarker, FilesetResolver } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/vision_bundle.mjs';

		// =====================================================================
		// ARCHITECTURE ENFORCEMENT
		// All smoothing/FSM/emitting MUST go through HFO adapters.
		// Direct usage of npm packages is BLOCKED by anti-theater gate.
		// =====================================================================

		// State
		let smoother = null;
		let smootherType = '1euro';
		let video = null;
		let handLandmarker = null;
		let isRunning = false;

		// Metrics
		const metrics = {
			fps: 0,
			latency: 0,
			smoothness: 0,
			framesProcessed: 0,
			lastFrameTime: 0,
		};

		// =====================================================================
		// Golden Layout Configuration
		// =====================================================================
		const config = {
			root: {
				type: 'row',
				content: [
					{
						type: 'column',
						width: 30,
						content: [
							{
								type: 'component',
								title: 'üì∑ Camera',
								componentType: 'camera',
								height: 50,
							},
							{
								type: 'component',
								title: '‚öôÔ∏è Settings',
								componentType: 'settings',
							}
						]
					},
					{
						type: 'column',
						width: 50,
						content: [
							{
								type: 'component',
								title: 'üéØ Cursor Area',
								componentType: 'cursor',
							}
						]
					},
					{
						type: 'column',
						width: 20,
						content: [
							{
								type: 'component',
								title: 'üèóÔ∏è Architecture',
								componentType: 'architecture',
								height: 60,
							},
							{
								type: 'component',
								title: 'üìä Metrics',
								componentType: 'metrics',
							}
						]
					}
				]
			}
		};

		// =====================================================================
		// Panel Renderers
		// =====================================================================
		function renderCameraPanel(container) {
			container.element.innerHTML = `
				<div class="panel" id="camera-panel">
					<h3>Camera Feed</h3>
					<video id="camera-video" autoplay playsinline></video>
					<button id="start-btn" style="width:100%;padding:12px;margin-top:12px;background:#4fc3f7;border:none;border-radius:4px;cursor:pointer;">
						Start Camera
					</button>
				</div>
			`;

			const startBtn = container.element.querySelector('#start-btn');
			video = container.element.querySelector('#camera-video');

			startBtn.addEventListener('click', async () => {
				if (!isRunning) {
					await startCamera();
					startBtn.textContent = 'Stop Camera';
					startBtn.style.background = '#ff6464';
				} else {
					stopCamera();
					startBtn.textContent = 'Start Camera';
					startBtn.style.background = '#4fc3f7';
				}
			});
		}

		function renderCursorPanel(container) {
			container.element.innerHTML = `
				<div class="panel">
					<h3>Gesture Tracking</h3>
					<div id="cursor-area">
						<div class="cursor-dot cursor-raw" id="cursor-raw"></div>
						<div class="cursor-dot cursor-smoothed" id="cursor-smoothed"></div>
					</div>
					<div style="margin-top:12px;font-size:11px;color:#888;">
						<span style="color:#ff6464;">‚óè</span> Raw &nbsp;&nbsp;
						<span style="color:#64ff64;">‚óè</span> Smoothed (HFO.${smootherType})
					</div>
				</div>
			`;
		}

		function renderSettingsPanel(container) {
			container.element.innerHTML = `
				<div class="panel">
					<h3>Pipeline Settings</h3>
					
					<div class="setting-group">
						<label>Smoother Adapter</label>
						<select id="smoother-select">
							<option value="1euro" selected>HFO.OneEuroExemplarAdapter</option>
							<option value="rapier-smooth">HFO.RapierPhysicsAdapter (smooth)</option>
							<option value="rapier-predict">HFO.RapierPhysicsAdapter (predict)</option>
						</select>
					</div>
					
					<div class="setting-group" id="1euro-settings">
						<label>Min Cutoff</label>
						<input type="range" id="min-cutoff" min="0.1" max="5" step="0.1" value="1.0">
						<div class="setting-value" id="min-cutoff-val">1.0 Hz</div>
						
						<label style="margin-top:12px;">Beta (Speed)</label>
						<input type="range" id="beta" min="0" max="1" step="0.01" value="0.007">
						<div class="setting-value" id="beta-val">0.007</div>
					</div>
					
					<div class="setting-group" id="rapier-settings" style="display:none;">
						<label>Stiffness</label>
						<input type="range" id="stiffness" min="50" max="500" step="10" value="150">
						<div class="setting-value" id="stiffness-val">150</div>
						
						<label style="margin-top:12px;">Damping</label>
						<input type="range" id="damping" min="1" max="50" step="1" value="12">
						<div class="setting-value" id="damping-val">12</div>
					</div>
				</div>
			`;

			// Event listeners
			const smootherSelect = container.element.querySelector('#smoother-select');
			smootherSelect.addEventListener('change', (e) => {
				smootherType = e.target.value;
				initSmoother();
				updateSettingsVisibility(container);
			});

			// 1‚Ç¨ settings
			['min-cutoff', 'beta'].forEach(id => {
				const input = container.element.querySelector(`#${id}`);
				input?.addEventListener('input', (e) => {
					container.element.querySelector(`#${id}-val`).textContent = 
						id === 'min-cutoff' ? `${e.target.value} Hz` : e.target.value;
					if (smoother && smootherType === '1euro') {
						initSmoother();
					}
				});
			});

			// Rapier settings
			['stiffness', 'damping'].forEach(id => {
				const input = container.element.querySelector(`#${id}`);
				input?.addEventListener('input', (e) => {
					container.element.querySelector(`#${id}-val`).textContent = e.target.value;
					if (smoother && smootherType.startsWith('rapier')) {
						initSmoother();
					}
				});
			});
		}

		function updateSettingsVisibility(container) {
			const euroSettings = container.element.querySelector('#1euro-settings');
			const rapierSettings = container.element.querySelector('#rapier-settings');
			
			if (smootherType === '1euro') {
				euroSettings.style.display = 'block';
				rapierSettings.style.display = 'none';
			} else {
				euroSettings.style.display = 'none';
				rapierSettings.style.display = 'block';
			}
		}

		function renderArchitecturePanel(container) {
			container.element.innerHTML = `
				<div class="panel">
					<h3>Pipeline Architecture</h3>
					
					<div class="arch-stage" id="stage-sensor">
						<h4>1. Sensor</h4>
						<p>MediaPipe Hand Landmarker</p>
						<div class="adapter">CDN import (raw input)</div>
					</div>
					
					<div class="arch-stage active" id="stage-smoother">
						<h4>2. Smoother</h4>
						<p>1‚Ç¨ Filter or Rapier Physics</p>
						<div class="adapter">HFO.OneEuroExemplarAdapter</div>
					</div>
					
					<div class="arch-stage" id="stage-fsm">
						<h4>3. FSM</h4>
						<p>Gesture State Machine</p>
						<div class="adapter">HFO.XStateFSMAdapter (TODO)</div>
					</div>
					
					<div class="arch-stage" id="stage-emitter">
						<h4>4. Emitter</h4>
						<p>W3C Pointer Events</p>
						<div class="adapter">HFO.PointerEventAdapter (TODO)</div>
					</div>
					
					<div class="arch-stage" id="stage-target">
						<h4>5. Target</h4>
						<p>DOM dispatchEvent</p>
						<div class="adapter">HFO.DOMAdapter (TODO)</div>
					</div>
				</div>
			`;
		}

		function renderMetricsPanel(container) {
			container.element.innerHTML = `
				<div class="panel">
					<h3>Performance Metrics</h3>
					
					<div class="metric">
						<span class="metric-label">FPS</span>
						<span class="metric-value" id="metric-fps">0</span>
					</div>
					
					<div class="metric">
						<span class="metric-label">Latency</span>
						<span class="metric-value" id="metric-latency">0 ms</span>
					</div>
					
					<div class="metric">
						<span class="metric-label">Smoothness</span>
						<span class="metric-value" id="metric-smoothness">0%</span>
					</div>
					
					<div class="metric">
						<span class="metric-label">Frames</span>
						<span class="metric-value" id="metric-frames">0</span>
					</div>
					
					<div class="metric">
						<span class="metric-label">Smoother</span>
						<span class="metric-value" id="metric-smoother">1euro</span>
					</div>
				</div>
			`;
		}

		// =====================================================================
		// Initialize Smoother (USES HFO ADAPTERS ONLY)
		// =====================================================================
		async function initSmoother() {
			// Wait for HFO bundle to be ready
			if (typeof window.initHFO === 'function') {
				await window.initHFO();
			}

			const HFO = window.HFO;
			if (!HFO) {
				console.error('HFO adapter bundle not loaded!');
				return;
			}

			switch (smootherType) {
				case '1euro':
					// USE ADAPTER, NOT DIRECT npm IMPORT
					smoother = new HFO.OneEuroExemplarAdapter({
						minCutoff: parseFloat(document.querySelector('#min-cutoff')?.value || '1.0'),
						beta: parseFloat(document.querySelector('#beta')?.value || '0.007'),
						dCutoff: 1.0,
					});
					break;

				case 'rapier-smooth':
					// USE ADAPTER, NOT DIRECT RAPIER API
					smoother = await HFO.createSmoothedRapierAdapter({
						stiffness: parseFloat(document.querySelector('#stiffness')?.value || '150'),
						damping: parseFloat(document.querySelector('#damping')?.value || '12'),
					});
					break;

				case 'rapier-predict':
					// USE ADAPTER, NOT DIRECT RAPIER API
					smoother = await HFO.createPredictiveRapierAdapter({
						stiffness: parseFloat(document.querySelector('#stiffness')?.value || '150'),
						damping: parseFloat(document.querySelector('#damping')?.value || '12'),
						latencyMs: 16,
					});
					break;
			}

			// Update architecture panel
			const adapterDiv = document.querySelector('#stage-smoother .adapter');
			if (adapterDiv) {
				adapterDiv.textContent = `HFO.${smoother?.constructor.name || smootherType}`;
			}

			// Update metrics
			const metricSmoother = document.querySelector('#metric-smoother');
			if (metricSmoother) metricSmoother.textContent = smootherType;

			console.log(`[HFO] Smoother initialized: ${smootherType}`);
		}

		// =====================================================================
		// Camera & Processing
		// =====================================================================
		async function startCamera() {
			try {
				// Get camera stream
				const stream = await navigator.mediaDevices.getUserMedia({
					video: { width: 640, height: 480, facingMode: 'user' }
				});
				video.srcObject = stream;
				await video.play();

				// Initialize MediaPipe (sensor layer - this is allowed to use CDN)
				const vision = await FilesetResolver.forVisionTasks(
					'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm'
				);
				handLandmarker = await HandLandmarker.createFromOptions(vision, {
					baseOptions: {
						modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task',
						delegate: 'GPU',
					},
					runningMode: 'VIDEO',
					numHands: 1,
				});

				// Initialize smoother adapter
				await initSmoother();

				isRunning = true;
				processFrame();
				console.log('[HFO] Camera started');
			} catch (err) {
				console.error('Camera error:', err);
				alert('Failed to start camera: ' + err.message);
			}
		}

		function stopCamera() {
			isRunning = false;
			if (video?.srcObject) {
				video.srcObject.getTracks().forEach(t => t.stop());
			}
		}

		function processFrame() {
			if (!isRunning || !handLandmarker || !video) return;

			const startTime = performance.now();

			// Get hand landmarks from MediaPipe
			const results = handLandmarker.detectForVideo(video, startTime);

			if (results.landmarks && results.landmarks.length > 0) {
				// Get index finger tip (landmark 8)
				const landmark = results.landmarks[0][8];
				const rawX = landmark.x * 100;  // Convert to percentage
				const rawY = landmark.y * 100;

				// Update raw cursor
				const rawCursor = document.getElementById('cursor-raw');
				if (rawCursor) {
					rawCursor.style.left = `${rawX}%`;
					rawCursor.style.top = `${rawY}%`;
				}

				// Apply smoothing through HFO adapter
				if (smoother) {
					const smoothed = smoother.smooth({ x: rawX, y: rawY }, startTime);
					
					// Update smoothed cursor
					const smoothedCursor = document.getElementById('cursor-smoothed');
					if (smoothedCursor) {
						smoothedCursor.style.left = `${smoothed.x}%`;
						smoothedCursor.style.top = `${smoothed.y}%`;
					}

					// Calculate smoothness metric
					const rawDist = Math.sqrt(
						Math.pow(rawX - (metrics.lastRawX || rawX), 2) +
						Math.pow(rawY - (metrics.lastRawY || rawY), 2)
					);
					const smoothDist = Math.sqrt(
						Math.pow(smoothed.x - (metrics.lastSmoothX || smoothed.x), 2) +
						Math.pow(smoothed.y - (metrics.lastSmoothY || smoothed.y), 2)
					);
					
					metrics.lastRawX = rawX;
					metrics.lastRawY = rawY;
					metrics.lastSmoothX = smoothed.x;
					metrics.lastSmoothY = smoothed.y;
					
					if (rawDist > 0) {
						metrics.smoothness = Math.min(100, Math.max(0, 
							100 - (smoothDist / rawDist * 50)
						));
					}
				}
			}

			// Update metrics
			metrics.framesProcessed++;
			metrics.latency = performance.now() - startTime;
			
			if (metrics.lastFrameTime > 0) {
				metrics.fps = 1000 / (startTime - metrics.lastFrameTime);
			}
			metrics.lastFrameTime = startTime;

			updateMetricsUI();

			requestAnimationFrame(processFrame);
		}

		function updateMetricsUI() {
			const fpsEl = document.getElementById('metric-fps');
			const latencyEl = document.getElementById('metric-latency');
			const smoothnessEl = document.getElementById('metric-smoothness');
			const framesEl = document.getElementById('metric-frames');

			if (fpsEl) fpsEl.textContent = metrics.fps.toFixed(1);
			if (latencyEl) latencyEl.textContent = `${metrics.latency.toFixed(1)} ms`;
			if (smoothnessEl) smoothnessEl.textContent = `${metrics.smoothness.toFixed(0)}%`;
			if (framesEl) framesEl.textContent = metrics.framesProcessed.toString();
		}

		// =====================================================================
		// Initialize Golden Layout
		// =====================================================================
		const container = document.getElementById('golden-container');
		const layout = new GoldenLayout(container);

		layout.registerComponentFactoryFunction('camera', renderCameraPanel);
		layout.registerComponentFactoryFunction('cursor', renderCursorPanel);
		layout.registerComponentFactoryFunction('settings', renderSettingsPanel);
		layout.registerComponentFactoryFunction('architecture', renderArchitecturePanel);
		layout.registerComponentFactoryFunction('metrics', renderMetricsPanel);

		layout.loadLayout(config);

		console.log('[HFO] Golden Layout initialized');
		console.log('[HFO] Adapter bundle version:', window.HFO?.VERSION || 'loading...');
	</script>
</body>
</html>
