<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFO Gen87 ‚Äî Unified Pipeline Showcase</title>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --accent-red: #f85149;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-orange: #d29922;
            --accent-purple: #a371f7;
            --text: #e6edf3;
            --text-dim: #8b949e;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            padding: 16px 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        header h1 .badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: var(--accent-green);
            color: black;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .input-select {
            display: flex;
            gap: 8px;
        }
        
        .input-btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .input-btn.active { border-color: var(--accent-green); color: var(--accent-green); }
        .input-btn:hover:not(.active) { border-color: var(--accent-blue); }
        
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 0;
        }
        
        .canvas-container {
            position: relative;
            background: #010409;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .overlay {
            position: absolute;
            padding: 12px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            font-size: 0.75rem;
        }
        
        .overlay.status { top: 12px; left: 12px; }
        .overlay.legend { bottom: 12px; left: 12px; display: flex; gap: 16px; }
        .overlay.stats { top: 12px; right: 12px; }
        
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        
        .stat-row { display: flex; justify-content: space-between; gap: 20px; margin: 4px 0; }
        .stat-value { font-family: monospace; color: var(--accent-blue); }
        
        .sidebar {
            background: var(--bg-card);
            padding: 16px;
            border-left: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 14px;
        }
        
        .panel h3 {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel h3 .tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: var(--accent-purple);
            color: white;
            border-radius: 4px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }
        
        .control-row label {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-row .source {
            font-size: 0.6rem;
            color: var(--accent-orange);
            padding: 1px 4px;
            background: rgba(210, 153, 34, 0.2);
            border-radius: 3px;
        }
        
        .control-row input[type="range"] {
            width: 100px;
            accent-color: var(--accent-blue);
        }
        
        .control-row .val {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--accent-blue);
            min-width: 45px;
            text-align: right;
        }
        
        .smoother-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .smoother-tab {
            flex: 1;
            padding: 8px 4px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        
        .smoother-tab.active {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: rgba(63, 185, 80, 0.1);
        }
        
        .smoother-panel { display: none; }
        .smoother-panel.active { display: block; }
        
        footer {
            padding: 10px 24px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
        }
        
        footer a { color: var(--accent-blue); text-decoration: none; }
        
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div>Loading HFO Adapters (REAL WASM)...</div>
    </div>
    
    <header>
        <h1>
            üï∏Ô∏è HFO Unified Pipeline
            <span class="badge">REAL ADAPTERS</span>
        </h1>
        <div class="input-select">
            <button class="input-btn active" data-input="mouse">üñ±Ô∏è Mouse</button>
            <button class="input-btn" data-input="camera">üì∑ Camera</button>
            <button class="input-btn" data-input="synthetic">üé≤ Synthetic</button>
        </div>
    </header>
    
    <main>
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            
            <div class="overlay status">
                <div>Input: <span id="currentInput">Mouse</span></div>
                <div>Smoother: <span id="currentSmoother">1‚Ç¨ Filter</span></div>
                <div>Pipeline: <span style="color: var(--accent-green)">REAL</span></div>
            </div>
            
            <div class="overlay legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-red)"></div>
                    <span>Raw Input</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-green)"></div>
                    <span>Smoothed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--accent-blue)"></div>
                    <span>Predicted</span>
                </div>
            </div>
            
            <div class="overlay stats">
                <div class="stat-row">
                    <span>Raw Jitter:</span>
                    <span class="stat-value" id="rawJitter">0.00</span>
                </div>
                <div class="stat-row">
                    <span>Smoothed Jitter:</span>
                    <span class="stat-value" id="smoothedJitter">0.00</span>
                </div>
                <div class="stat-row">
                    <span>Latency:</span>
                    <span class="stat-value" id="latency">0.00</span> ms
                </div>
                <div class="stat-row">
                    <span>FPS:</span>
                    <span class="stat-value" id="fps">60</span>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="panel">
                <h3>
                    Smoother Selection
                    <span class="tag">Port 2 / SHAPE</span>
                </h3>
                <div class="smoother-tabs">
                    <button class="smoother-tab active" data-smoother="oneeuro">1‚Ç¨</button>
                    <button class="smoother-tab" data-smoother="rapier">Physics</button>
                    <button class="smoother-tab" data-smoother="desp">DESP</button>
                </div>
                
                <!-- 1‚Ç¨ Filter Controls -->
                <div class="smoother-panel active" id="oneEuroPanel">
                    <div class="control-row">
                        <label>Min Cutoff <span class="source">@CHI2012</span></label>
                        <input type="range" id="mincutoff" min="0.1" max="10" step="0.1" value="1.0">
                        <span class="val" id="mincutoffVal">1.0</span>
                    </div>
                    <div class="control-row">
                        <label>Beta <span class="source">@CHI2012</span></label>
                        <input type="range" id="beta" min="0" max="1" step="0.001" value="0.007">
                        <span class="val" id="betaVal">0.007</span>
                    </div>
                </div>
                
                <!-- Rapier Physics Controls -->
                <div class="smoother-panel" id="rapierPanel">
                    <div class="control-row">
                        <label>Stiffness <span class="source">@HFO</span></label>
                        <input type="range" id="stiffness" min="100" max="500" step="10" value="200">
                        <span class="val" id="stiffnessVal">200</span>
                    </div>
                    <div class="control-row">
                        <label>Damping <span class="source">@HFO</span></label>
                        <input type="range" id="damping" min="0.5" max="2.0" step="0.1" value="1.2">
                        <span class="val" id="dampingVal">1.2</span>
                    </div>
                    <div class="control-row">
                        <label>Dead Zone <span class="source">@XInput</span></label>
                        <input type="range" id="deadzone" min="0.05" max="0.25" step="0.01" value="0.10">
                        <span class="val" id="deadzoneVal">0.10</span>
                    </div>
                </div>
                
                <!-- DESP Controls -->
                <div class="smoother-panel" id="despPanel">
                    <div class="control-row">
                        <label>Alpha <span class="source">@LaViola03</span></label>
                        <input type="range" id="despAlpha" min="0.1" max="0.9" step="0.05" value="0.5">
                        <span class="val" id="despAlphaVal">0.5</span>
                    </div>
                    <div class="control-row">
                        <label>Predict ms <span class="source">@LaViola03</span></label>
                        <input type="range" id="despPredict" min="0" max="100" step="5" value="50">
                        <span class="val" id="despPredictVal">50</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>Noise Generator</h3>
                <div class="control-row">
                    <label>Jitter Amount</label>
                    <input type="range" id="jitterAmount" min="0" max="0.05" step="0.001" value="0.01">
                    <span class="val" id="jitterAmountVal">0.010</span>
                </div>
            </div>
            
            <div class="panel">
                <h3>Architecture</h3>
                <div style="font-size: 0.75rem; color: var(--text-dim); line-height: 1.6;">
                    <div>Port 0: SensorPort (SENSE)</div>
                    <div>‚Üì NoisyLandmark</div>
                    <div>Port 1: BridgerPort (FUSE)</div>
                    <div>‚Üì SensorFrame</div>
                    <div style="color: var(--accent-green)">Port 2: SmootherPort (SHAPE)</div>
                    <div>‚Üì SmoothedFrame</div>
                    <div>Port 3: FSMPort (DELIVER)</div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div>HFO Gen87.X3 | <a href="index.html">‚Üê All Demos</a></div>
        <div>REAL ADAPTERS: OneEuroExemplarAdapter, RapierPhysicsAdapter, DoubleExponentialPredictor</div>
    </footer>

    <script type="module">
        // ============================================================================
        // IMPORT REAL HFO ADAPTERS (Built from TypeScript)
        // ============================================================================
        import {
            // Real Adapters
            OneEuroExemplarAdapter,
            RapierPhysicsAdapter,
            DoubleExponentialPredictor,
            
            // Types
            createSensorFrameFromMouse,
            addJitter,
            
            // Constants
            ONE_EURO_MINCUTOFF_DEFAULT,
            ONE_EURO_BETA_DEFAULT,
            RAPIER_STIFFNESS_DEFAULT,
            RAPIER_DAMPING_DEFAULT,
            DEAD_ZONE_DEFAULT,
        } from './lib/hfo.js';
        
        console.log('‚úÖ HFO Real Adapters Loaded');
        console.log('   - OneEuroExemplarAdapter:', typeof OneEuroExemplarAdapter);
        console.log('   - RapierPhysicsAdapter:', typeof RapierPhysicsAdapter);
        console.log('   - DoubleExponentialPredictor:', typeof DoubleExponentialPredictor);
        
        // ============================================================================
        // CANVAS SETUP
        // ============================================================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ============================================================================
        // STATE
        // ============================================================================
        let inputMode = 'mouse';
        let currentSmootherType = 'oneeuro';
        let mouseX = 0.5, mouseY = 0.5;
        
        // Trail histories
        const TRAIL_LENGTH = 100;
        const rawTrail = [];
        const smoothedTrail = [];
        const predictedTrail = [];
        
        // ============================================================================
        // REAL SMOOTHER INSTANCES
        // ============================================================================
        let oneEuroSmoother = null;
        let rapierSmoother = null;
        let despSmoother = null;
        
        // Initialize smoothers after Rapier WASM loads
        async function initSmoothers() {
            try {
                // 1‚Ç¨ Filter - REAL npm package by Casiez
                oneEuroSmoother = new OneEuroExemplarAdapter({
                    frequency: 60,
                    minCutoff: ONE_EURO_MINCUTOFF_DEFAULT,
                    beta: ONE_EURO_BETA_DEFAULT,
                });
                console.log('‚úÖ OneEuroExemplarAdapter initialized');
                
                // Rapier Physics - REAL WASM (may need async init)
                rapierSmoother = new RapierPhysicsAdapter({
                    mode: 'smoothed',
                    stiffness: RAPIER_STIFFNESS_DEFAULT,
                    damping: RAPIER_DAMPING_DEFAULT,
                    velocityDeadZone: DEAD_ZONE_DEFAULT,
                });
                console.log('‚úÖ RapierPhysicsAdapter initialized');
                
                // DESP - LaViola 2003
                despSmoother = new DoubleExponentialPredictor({
                    alpha: 0.5,
                    predictionMs: 50,
                    clampOutput: true,
                });
                console.log('‚úÖ DoubleExponentialPredictor initialized');
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (err) {
                console.error('Failed to initialize smoothers:', err);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="color: var(--accent-red)">‚ùå Failed to load: ${err.message}</div>
                    <div style="font-size: 0.8rem; margin-top: 8px">Check console for details</div>
                `;
            }
        }
        
        // Get current smoother
        function getCurrentSmoother() {
            switch (currentSmootherType) {
                case 'oneeuro': return oneEuroSmoother;
                case 'rapier': return rapierSmoother;
                case 'desp': return despSmoother;
                default: return oneEuroSmoother;
            }
        }
        
        // ============================================================================
        // MOUSE TRACKING
        // ============================================================================
        canvas.addEventListener('mousemove', (e) => {
            if (inputMode !== 'mouse') return;
            const rect = canvas.getBoundingClientRect();
            mouseX = (e.clientX - rect.left) / rect.width;
            mouseY = (e.clientY - rect.top) / rect.height;
        });
        
        // ============================================================================
        // SYNTHETIC NOISE MODE
        // ============================================================================
        let syntheticAngle = 0;
        
        function getSyntheticPosition() {
            syntheticAngle += 0.02;
            const baseX = 0.5 + Math.cos(syntheticAngle) * 0.3;
            const baseY = 0.5 + Math.sin(syntheticAngle * 0.7) * 0.25;
            return { x: baseX, y: baseY };
        }
        
        // ============================================================================
        // CONTROLS
        // ============================================================================
        // Input mode buttons
        document.querySelectorAll('.input-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.input-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                inputMode = btn.dataset.input;
                document.getElementById('currentInput').textContent = 
                    inputMode === 'mouse' ? 'Mouse' : 
                    inputMode === 'camera' ? 'Camera' : 'Synthetic';
            });
        });
        
        // Smoother tabs
        document.querySelectorAll('.smoother-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.smoother-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.smoother-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                currentSmootherType = tab.dataset.smoother;
                document.getElementById(`${currentSmootherType === 'oneeuro' ? 'oneEuro' : currentSmootherType}Panel`).classList.add('active');
                document.getElementById('currentSmoother').textContent = 
                    currentSmootherType === 'oneeuro' ? '1‚Ç¨ Filter' :
                    currentSmootherType === 'rapier' ? 'Rapier Physics' : 'DESP';
                    
                // Reset current smoother
                const smoother = getCurrentSmoother();
                if (smoother) smoother.reset();
            });
        });
        
        // 1‚Ç¨ Filter controls
        document.getElementById('mincutoff').addEventListener('input', (e) => {
            document.getElementById('mincutoffVal').textContent = parseFloat(e.target.value).toFixed(1);
            if (oneEuroSmoother) {
                oneEuroSmoother.setParams(parseFloat(e.target.value), parseFloat(document.getElementById('beta').value));
            }
        });
        
        document.getElementById('beta').addEventListener('input', (e) => {
            document.getElementById('betaVal').textContent = parseFloat(e.target.value).toFixed(3);
            if (oneEuroSmoother) {
                oneEuroSmoother.setParams(parseFloat(document.getElementById('mincutoff').value), parseFloat(e.target.value));
            }
        });
        
        // Rapier controls
        ['stiffness', 'damping', 'deadzone'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById(`${id}Val`).textContent = id === 'deadzone' ? val.toFixed(2) : val.toFixed(1);
                // Rapier config would be updated via setParams if interface supports it
            });
        });
        
        // DESP controls
        ['despAlpha', 'despPredict'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById(`${id}Val`).textContent = id === 'despAlpha' ? val.toFixed(2) : val.toFixed(0);
            });
        });
        
        // Jitter control
        document.getElementById('jitterAmount').addEventListener('input', (e) => {
            document.getElementById('jitterAmountVal').textContent = parseFloat(e.target.value).toFixed(3);
        });
        
        // ============================================================================
        // JITTER MEASUREMENT
        // ============================================================================
        function measureJitter(trail) {
            if (trail.length < 3) return 0;
            let totalJitter = 0;
            for (let i = 2; i < trail.length; i++) {
                const dx1 = trail[i].x - trail[i-1].x;
                const dy1 = trail[i].y - trail[i-1].y;
                const dx2 = trail[i-1].x - trail[i-2].x;
                const dy2 = trail[i-1].y - trail[i-2].y;
                const ddx = dx1 - dx2;
                const ddy = dy1 - dy2;
                totalJitter += Math.sqrt(ddx*ddx + ddy*ddy);
            }
            return totalJitter / (trail.length - 2);
        }
        
        // ============================================================================
        // RENDER LOOP
        // ============================================================================
        let lastTime = performance.now();
        let frameCount = 0;
        let lastFpsTime = 0;
        
        function render(time) {
            const dt = (time - lastTime) / 1000;
            lastTime = time;
            frameCount++;
            
            // FPS calculation
            if (time - lastFpsTime > 500) {
                document.getElementById('fps').textContent = Math.round(frameCount * 2).toString();
                frameCount = 0;
                lastFpsTime = time;
            }
            
            // Clear canvas
            ctx.fillStyle = '#010409';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#161b22';
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
            }
            
            // Get input position
            let rawX, rawY;
            if (inputMode === 'synthetic') {
                const pos = getSyntheticPosition();
                rawX = pos.x;
                rawY = pos.y;
            } else {
                rawX = mouseX;
                rawY = mouseY;
            }
            
            // Add jitter
            const jitterAmount = parseFloat(document.getElementById('jitterAmount').value);
            const noisyX = addJitter(rawX, jitterAmount);
            const noisyY = addJitter(rawY, jitterAmount);
            
            // Create SensorFrame (REAL schema)
            const sensorFrame = createSensorFrameFromMouse(noisyX, noisyY, time);
            
            // Apply smoothing through REAL adapter
            const smoother = getCurrentSmoother();
            let smoothedFrame = null;
            
            if (smoother) {
                try {
                    smoothedFrame = smoother.smooth(sensorFrame);
                } catch (err) {
                    console.error('Smoother error:', err);
                }
            }
            
            // Extract positions
            const smoothedX = smoothedFrame?.position?.x ?? noisyX;
            const smoothedY = smoothedFrame?.position?.y ?? noisyY;
            const predictedX = smoothedFrame?.prediction?.x ?? smoothedX;
            const predictedY = smoothedFrame?.prediction?.y ?? smoothedY;
            
            // Update trails
            rawTrail.push({ x: noisyX, y: noisyY });
            smoothedTrail.push({ x: smoothedX, y: smoothedY });
            predictedTrail.push({ x: predictedX, y: predictedY });
            
            if (rawTrail.length > TRAIL_LENGTH) rawTrail.shift();
            if (smoothedTrail.length > TRAIL_LENGTH) smoothedTrail.shift();
            if (predictedTrail.length > TRAIL_LENGTH) predictedTrail.shift();
            
            // Draw trails
            function drawTrail(trail, color) {
                if (trail.length < 2) return;
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(trail[0].x * canvas.width, trail[0].y * canvas.height);
                for (let i = 1; i < trail.length; i++) {
                    ctx.globalAlpha = i / trail.length;
                    ctx.lineTo(trail[i].x * canvas.width, trail[i].y * canvas.height);
                }
                ctx.globalAlpha = 1;
                ctx.stroke();
            }
            
            drawTrail(rawTrail, '#f85149');
            drawTrail(smoothedTrail, '#3fb950');
            if (currentSmootherType === 'desp') {
                drawTrail(predictedTrail, '#58a6ff');
            }
            
            // Draw current positions
            function drawDot(x, y, color, size) {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x * canvas.width, y * canvas.height, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            drawDot(noisyX, noisyY, '#f85149', 6);
            drawDot(smoothedX, smoothedY, '#3fb950', 10);
            if (currentSmootherType === 'desp') {
                drawDot(predictedX, predictedY, '#58a6ff', 8);
            }
            
            // Update stats
            const rawJitter = measureJitter(rawTrail);
            const smoothJitter = measureJitter(smoothedTrail);
            document.getElementById('rawJitter').textContent = (rawJitter * 1000).toFixed(2);
            document.getElementById('smoothedJitter').textContent = (smoothJitter * 1000).toFixed(2);
            document.getElementById('latency').textContent = (dt * 1000).toFixed(1);
            
            requestAnimationFrame(render);
        }
        
        // Initialize and start
        initSmoothers().then(() => {
            requestAnimationFrame(render);
        });
    </script>
</body>
</html>
