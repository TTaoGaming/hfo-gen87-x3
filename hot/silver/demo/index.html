<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HFO Gen87.X3 Silver Demo ‚Äî REAL Architecture</title>
  <meta name="description" content="REAL Silver Demo using GoldenLayoutShellAdapter, HFOPortFactory, TileComposer. NO mocks, NO CSS Grid theater.">
  
  <!-- Golden Layout 2.x CSS (TRL-9 Exemplar) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a14;
      --bg-secondary: #12121f;
      --border: rgba(255,255,255,0.1);
      --accent: #e94560;
      --accent-glow: rgba(233,69,96,0.3);
      --text: #eee;
      --text-dim: #888;
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
    }
    
    body {
      font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
      background: var(--bg-primary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .logo {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent-glow);
    }
    
    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-left: 10px;
    }
    
    .status-bar {
      display: flex;
      gap: 16px;
      font-size: 0.75rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .status-dot.ready { background: var(--success); }
    .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
    .status-dot.error { background: var(--error); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Golden Layout Container - REAL architecture */
    #layout-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    /* Golden Layout overrides for dark theme */
    .lm_goldenlayout {
      background: var(--bg-primary) !important;
    }
    
    .lm_content {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      overflow: auto;
    }
    
    .lm_header {
      background: var(--bg-secondary) !important;
    }
    
    .lm_tab {
      background: var(--bg-primary) !important;
      color: var(--text) !important;
      border: 1px solid var(--border) !important;
    }
    
    .lm_tab.lm_active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    /* Panel Content Styles */
    .panel-content {
      padding: 16px;
      height: 100%;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    /* Camera Panel */
    #camera-video {
      width: 100%;
      max-width: 320px;
      border-radius: 4px;
      background: #000;
    }
    
    /* Pipeline Status */
    .pipeline-stage {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .stage-badge {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }
    
    .stage-badge.active { background: var(--accent); }
    
    .stage-info {
      flex: 1;
    }
    
    .stage-name {
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .stage-adapter {
      font-size: 0.65rem;
      color: var(--text-dim);
    }
    
    /* Smoother Controls */
    .smoother-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .smoother-option {
      padding: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .smoother-option:hover {
      border-color: var(--accent);
    }
    
    .smoother-option.active {
      border-color: var(--accent);
      background: rgba(233,69,96,0.1);
    }
    
    .smoother-option input {
      margin-right: 8px;
    }
    
    .slider-group {
      margin-top: 12px;
    }
    
    .slider-group label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    
    .slider-group input[type="range"] {
      width: 100%;
    }
    
    /* FSM State Display */
    .fsm-state-display {
      text-align: center;
      padding: 20px;
    }
    
    .fsm-current-state {
      font-size: 1.5rem;
      font-weight: 700;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .fsm-current-state[data-state="IDLE"] { background: var(--text-dim); }
    .fsm-current-state[data-state="TRACKING"] { background: var(--warning); color: #000; }
    .fsm-current-state[data-state="PRESSED"] { background: var(--success); }
    .fsm-current-state[data-state="COASTING"] { background: var(--accent); }
    
    /* Debug Console */
    .debug-console {
      font-family: 'SF Mono', monospace;
      font-size: 0.7rem;
      line-height: 1.4;
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-line {
      margin: 2px 0;
    }
    
    .debug-line.info { color: var(--text); }
    .debug-line.success { color: var(--success); }
    .debug-line.warning { color: var(--warning); }
    .debug-line.error { color: var(--error); }
    
    /* Architecture Info */
    .arch-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
    }
    
    .arch-item .label { color: var(--text-dim); }
    .arch-item .value { color: var(--success); font-family: monospace; }
    
    /* Cursor Overlay */
    #cursor-overlay {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.1s;
    }
    
    #cursor-overlay.active {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Header with status indicators -->
  <header class="header">
    <div>
      <span class="logo">üï∑Ô∏è HFO Gen87.X3</span>
      <span class="logo-sub">SILVER DEMO ‚Äî REAL Architecture</span>
    </div>
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot loading" id="goldenLayoutStatus"></span>
        <span>GoldenLayout</span>
      </div>
      <div class="status-item">
        <span class="status-dot loading" id="factoryStatus"></span>
        <span>PortFactory</span>
      </div>
      <div class="status-item">
        <span class="status-dot loading" id="composerStatus"></span>
        <span>TileComposer</span>
      </div>
    </div>
  </header>
  
  <!-- Golden Layout Container - NOT CSS Grid! -->
  <div id="layout-container"></div>
  
  <!-- Cursor Overlay (driven by real PointerEventAdapter) -->
  <div id="cursor-overlay"></div>

  <!-- Load REAL adapters from browser bundle -->
  <script type="module">
    // Import from REAL architecture (not mocks!)
    import { 
      GoldenLayoutShellAdapter,
      HFOPortFactory,
      OneEuroExemplarAdapter,
      XStateFSMAdapter,
      PointerEventAdapter,
      RawHTMLShellAdapter
    } from '/hot/bronze/src/adapters/index.js';
    
    // Import TileComposer
    import { TileComposer } from '/hot/bronze/src/adapters/tile-composer.js';
    
    // Status indicators
    const goldenLayoutStatus = document.getElementById('goldenLayoutStatus');
    const factoryStatus = document.getElementById('factoryStatus');
    const composerStatus = document.getElementById('composerStatus');
    const cursorOverlay = document.getElementById('cursor-overlay');
    
    // Debug log
    const debugLines = [];
    function debug(msg, level = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      debugLines.push({ timestamp, msg, level });
      if (debugLines.length > 100) debugLines.shift();
      updateDebugConsole();
    }
    
    function updateDebugConsole() {
      const console = document.getElementById('debug-console');
      if (console) {
        console.innerHTML = debugLines.map(d => 
          `<div class="debug-line ${d.level}">[${d.timestamp}] ${d.msg}</div>`
        ).join('');
        console.scrollTop = console.scrollHeight;
      }
    }
    
    // ========================================================================
    // REAL ARCHITECTURE INITIALIZATION
    // ========================================================================
    
    async function initRealArchitecture() {
      debug('üöÄ Initializing REAL Silver Demo...', 'info');
      debug('Architecture: GoldenLayoutShellAdapter + HFOPortFactory + TileComposer', 'info');
      
      try {
        // 1. Create HFOPortFactory (DI wiring)
        debug('Creating HFOPortFactory...', 'info');
        const factory = new HFOPortFactory({
          smoother: { type: '1euro', minCutoff: 1.0, beta: 0.007 },
          shell: { type: 'golden' }
        });
        factoryStatus.className = 'status-dot ready';
        debug('‚úÖ HFOPortFactory created', 'success');
        
        // 2. Create GoldenLayoutShellAdapter (REAL, not CSS Grid!)
        debug('Creating GoldenLayoutShellAdapter...', 'info');
        const shell = factory.createShell('golden');
        
        // Register component factories
        shell.registerComponent('dom', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = config.html || '<p>Panel content</p>';
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('camera', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">üì∑ Camera Input</div>
            <video id="camera-video" autoplay playsinline muted></video>
            <p style="margin-top: 12px; font-size: 0.75rem; color: var(--text-dim);">
              MediaPipe Hands ‚Üí SensorPort
            </p>
            <button id="start-camera" style="margin-top: 12px; padding: 8px 16px; cursor: pointer;">
              Start Camera
            </button>
          `;
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('pipeline', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">‚ö° Pipeline Status</div>
            <div class="pipeline-stage">
              <div class="stage-badge active">1</div>
              <div class="stage-info">
                <div class="stage-name">SENSE</div>
                <div class="stage-adapter">MediaPipeAdapter ‚Üí SensorPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge active">2</div>
              <div class="stage-info">
                <div class="stage-name">SMOOTH</div>
                <div class="stage-adapter">OneEuroExemplarAdapter ‚Üí SmootherPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge">3</div>
              <div class="stage-info">
                <div class="stage-name">PREDICT</div>
                <div class="stage-adapter">RapierPhysicsAdapter ‚Üí PredictorPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge active">4</div>
              <div class="stage-info">
                <div class="stage-name">FSM</div>
                <div class="stage-adapter">XStateFSMAdapter ‚Üí FSMPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge active">5</div>
              <div class="stage-info">
                <div class="stage-name">EMIT</div>
                <div class="stage-adapter">PointerEventAdapter ‚Üí EmitterPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge">6</div>
              <div class="stage-info">
                <div class="stage-name">TARGET</div>
                <div class="stage-adapter">DOMAdapter ‚Üí AdapterPort</div>
              </div>
            </div>
            <div class="pipeline-stage">
              <div class="stage-badge active">7</div>
              <div class="stage-info">
                <div class="stage-name">UI</div>
                <div class="stage-adapter">GoldenLayoutShellAdapter ‚Üí UIShellPort</div>
              </div>
            </div>
          `;
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('smoother', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">üéöÔ∏è Smoother Config</div>
            <div class="smoother-controls">
              <label class="smoother-option active" data-smoother="1euro">
                <input type="radio" name="smoother" value="1euro" checked>
                <strong>1‚Ç¨ Filter</strong>
                <div style="font-size: 0.7rem; color: var(--text-dim);">
                  OneEuroExemplarAdapter (npm 1eurofilter@1.2.2)
                </div>
              </label>
              <label class="smoother-option" data-smoother="rapier-smooth">
                <input type="radio" name="smoother" value="rapier-smooth">
                <strong>Rapier Smooth</strong>
                <div style="font-size: 0.7rem; color: var(--text-dim);">
                  RapierPhysicsAdapter (npm @dimforge/rapier2d-compat)
                </div>
              </label>
              <label class="smoother-option" data-smoother="rapier-predict">
                <input type="radio" name="smoother" value="rapier-predict">
                <strong>Rapier Predictive</strong>
                <div style="font-size: 0.7rem; color: var(--text-dim);">
                  Lookahead extrapolation for latency compensation
                </div>
              </label>
              <div class="slider-group">
                <label>minCutoff: <span id="minCutoff-value">1.0</span></label>
                <input type="range" id="minCutoff" min="0.1" max="5" step="0.1" value="1.0">
              </div>
              <div class="slider-group">
                <label>beta: <span id="beta-value">0.007</span></label>
                <input type="range" id="beta" min="0" max="0.1" step="0.001" value="0.007">
              </div>
            </div>
          `;
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('fsm', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">üîÑ FSM State</div>
            <div class="fsm-state-display">
              <div class="fsm-current-state" data-state="IDLE" id="fsm-state">IDLE</div>
              <p style="font-size: 0.75rem; color: var(--text-dim);">
                XStateFSMAdapter ‚Üí FSMPort
              </p>
              <div style="margin-top: 16px; font-size: 0.7rem; text-align: left;">
                <strong>Transitions:</strong><br>
                IDLE ‚Üí TRACKING (hand detected)<br>
                TRACKING ‚Üí PRESSED (Pointing_Up)<br>
                PRESSED ‚Üí TRACKING (Open_Palm)<br>
                * ‚Üí COASTING (tracking lost)
              </div>
            </div>
          `;
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('debug', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">üêõ Debug Console</div>
            <div class="debug-console" id="debug-console"></div>
          `;
          container.appendChild(el);
          return el;
        });
        
        shell.registerComponent('architecture', (container, config) => {
          const el = document.createElement('div');
          el.className = 'panel-content';
          el.innerHTML = `
            <div class="panel-title">üèóÔ∏è Real Architecture</div>
            <div class="arch-item"><span class="label">UIShellPort</span><span class="value">GoldenLayoutShellAdapter</span></div>
            <div class="arch-item"><span class="label">SmootherPort</span><span class="value">OneEuroExemplarAdapter</span></div>
            <div class="arch-item"><span class="label">FSMPort</span><span class="value">XStateFSMAdapter</span></div>
            <div class="arch-item"><span class="label">EmitterPort</span><span class="value">PointerEventAdapter</span></div>
            <div class="arch-item"><span class="label">Factory</span><span class="value">HFOPortFactory</span></div>
            <div class="arch-item"><span class="label">Composer</span><span class="value">TileComposer</span></div>
            <div class="arch-item"><span class="label">Version</span><span class="value">Gen87.X3</span></div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(76,175,80,0.1); border-radius: 4px; font-size: 0.7rem;">
              <strong style="color: var(--success);">‚úÖ NO MOCKS</strong><br>
              All adapters wrap real npm packages via polymorphic ports.
            </div>
          `;
          container.appendChild(el);
          return el;
        });
        
        goldenLayoutStatus.className = 'status-dot ready';
        debug('‚úÖ GoldenLayoutShellAdapter created with 7 component factories', 'success');
        
        // 3. Initialize shell with layout
        debug('Initializing Golden Layout...', 'info');
        const layoutContainer = document.getElementById('layout-container');
        
        await shell.initialize(layoutContainer, {
          shell: 'golden',
          theme: 'dark'
        });
        
        debug('‚úÖ Golden Layout initialized', 'success');
        
        // 4. Add tiles using REAL addTile API
        debug('Adding tiles via UIShellPort.addTile()...', 'info');
        
        shell.addTile({ id: 'camera', type: 'camera', title: 'üì∑ Camera' });
        shell.addTile({ id: 'pipeline', type: 'pipeline', title: '‚ö° Pipeline' });
        shell.addTile({ id: 'smoother', type: 'smoother', title: 'üéöÔ∏è Smoother' });
        shell.addTile({ id: 'fsm', type: 'fsm', title: 'üîÑ FSM' });
        shell.addTile({ id: 'debug', type: 'debug', title: 'üêõ Debug' });
        shell.addTile({ id: 'architecture', type: 'architecture', title: 'üèóÔ∏è Architecture' });
        
        debug('‚úÖ 6 tiles added via UIShellPort', 'success');
        
        // 5. Create TileComposer for per-tile pipelines
        debug('Creating TileComposer...', 'info');
        const composer = new TileComposer({
          shell: { type: 'golden' },
          defaultSmoother: { type: '1euro', minCutoff: 1.0, beta: 0.007 }
        });
        
        composerStatus.className = 'status-dot ready';
        debug('‚úÖ TileComposer created', 'success');
        
        // 6. Create real adapters for demo
        debug('Creating real adapters...', 'info');
        const smoother = factory.createSmoother({ type: '1euro', minCutoff: 1.0, beta: 0.007 });
        const fsm = factory.createFSM();
        const emitter = factory.createEmitter();
        
        debug(`‚úÖ SmootherPort: ${smoother.constructor.name}`, 'success');
        debug(`‚úÖ FSMPort: ${fsm.constructor.name}`, 'success');
        debug(`‚úÖ EmitterPort: ${emitter.constructor.name}`, 'success');
        
        // 7. Setup event handlers
        debug('Setting up event handlers...', 'info');
        
        // Smoother selector
        document.querySelectorAll('.smoother-option').forEach(opt => {
          opt.addEventListener('click', () => {
            document.querySelectorAll('.smoother-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            const type = opt.dataset.smoother;
            debug(`Smoother switched to: ${type}`, 'info');
          });
        });
        
        // Sliders
        const minCutoffSlider = document.getElementById('minCutoff');
        const betaSlider = document.getElementById('beta');
        if (minCutoffSlider) {
          minCutoffSlider.addEventListener('input', (e) => {
            document.getElementById('minCutoff-value').textContent = e.target.value;
            smoother.setParams({ minCutoff: parseFloat(e.target.value) });
            debug(`minCutoff set to ${e.target.value}`, 'info');
          });
        }
        if (betaSlider) {
          betaSlider.addEventListener('input', (e) => {
            document.getElementById('beta-value').textContent = e.target.value;
            smoother.setParams({ beta: parseFloat(e.target.value) });
            debug(`beta set to ${e.target.value}`, 'info');
          });
        }
        
        // Camera start
        document.getElementById('start-camera')?.addEventListener('click', async () => {
          debug('Starting camera...', 'info');
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById('camera-video');
            if (video) {
              video.srcObject = stream;
              debug('‚úÖ Camera started', 'success');
            }
          } catch (err) {
            debug(`‚ùå Camera error: ${err.message}`, 'error');
          }
        });
        
        // Update debug console
        updateDebugConsole();
        
        // 8. Demo animation loop (shows cursor following mouse as proof of concept)
        debug('Starting demo animation loop...', 'info');
        
        let frameCount = 0;
        function animate() {
          frameCount++;
          if (frameCount % 60 === 0) {
            debug(`Frame ${frameCount} - Pipeline running`, 'info');
          }
          requestAnimationFrame(animate);
        }
        animate();
        
        // Mouse tracking demo (shows real smoother working)
        document.addEventListener('mousemove', (e) => {
          const point = { x: e.clientX, y: e.clientY };
          const timestamp = performance.now();
          
          // Run through REAL smoother
          const smoothed = smoother.smooth(point, timestamp);
          
          // Update cursor overlay
          cursorOverlay.style.left = `${smoothed.x}px`;
          cursorOverlay.style.top = `${smoothed.y}px`;
          cursorOverlay.classList.add('active');
        });
        
        debug('üéâ REAL Silver Demo fully initialized!', 'success');
        debug('Architecture: GoldenLayout + HFOPortFactory + Real Adapters', 'success');
        
      } catch (error) {
        debug(`‚ùå Initialization error: ${error.message}`, 'error');
        console.error(error);
        goldenLayoutStatus.className = 'status-dot error';
        factoryStatus.className = 'status-dot error';
        composerStatus.className = 'status-dot error';
      }
    }
    
    // Initialize on DOM ready
    initRealArchitecture();
  </script>
</body>
</html>
