#!/bin/sh
#
# PRE-COMMIT HOOK - HARD ENFORCEMENT
# 
# This hook validates demo files against the spec contract before allowing commits.
# It BLOCKS commits that introduce regressions.
#
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use husky:
#   npx husky add .husky/pre-commit "npm run validate:demos"

echo "üîç Running regression detection on demo files..."

# Get list of staged HTML files in demo-golden
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "sandbox/demo-golden/.*\.html$")

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No demo files staged - skipping validation"
    exit 0
fi

FAILED=0

for FILE in $STAGED_FILES; do
    echo ""
    echo "Validating: $FILE"
    
    # Run spec validator
    npx tsx scripts/validate-demo.ts "$FILE"
    if [ $? -ne 0 ]; then
        FAILED=1
    fi
    
    # Run regression detector (skip for base index.html)
    if [ "$FILE" != "sandbox/demo-golden/index.html" ]; then
        npx tsx scripts/regression-detector.ts "$FILE"
        if [ $? -ne 0 ]; then
            FAILED=1
        fi
    fi
done

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "üö® ========================================="
    echo "üö® PRE-COMMIT HOOK FAILED"
    echo "üö® ========================================="
    echo ""
    echo "Your commit contains regressions or spec violations."
    echo ""
    echo "Options:"
    echo "  1. Fix the issues and try again"
    echo "  2. git commit --no-verify (ONLY with human approval in INCIDENT_LOG)"
    echo ""
    exit 1
fi

echo ""
echo "‚úÖ All demo validations passed"
exit 0
