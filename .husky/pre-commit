#!/bin/sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ•¸ï¸  HFO Gen87 Pre-Commit Enforcement Gates                    â•‘"
echo "â•‘  HIVE/8 Phase: I (Interlock) - TDD RED/GREEN enforcement      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Gate 1: TypeScript type check
echo "ğŸ“‹ Gate 1/5: TypeCheck..."
npm run typecheck || {
  echo "âŒ G1 FAILED: TypeCheck errors detected."
  echo "   Fix type errors before committing."
  exit 1
}
echo "âœ… G1 PASSED"
echo ""

# Gate 2: Lint (Biome)
echo "ğŸ“‹ Gate 2/5: Lint..."
npm run lint || {
  echo "âŒ G2 FAILED: Lint errors detected."
  echo "   Run 'npm run lint:fix' to auto-fix."
  exit 1
}
echo "âœ… G2 PASSED"
echo ""

# Gate 3: Tests (only changed files for speed)
echo "ğŸ“‹ Gate 3/5: Tests (changed files)..."
npm run test:changed || {
  echo "âŒ G3 FAILED: Test failures detected."
  echo "   This is expected for TDD RED phase."
  echo "   Commit with 'I:' or 'H:' prefix for RED tests."
  exit 1
}
echo "âœ… G3 PASSED"
echo ""

# Gate 4: Architecture Enforcement (Reward Hacking Detection)
echo "ğŸ“‹ Gate 4/6: Architecture Compliance..."
npx tsx scripts/enforce-architecture.ts ./sandbox 2>/dev/null || {
  echo "âŒ G4 FAILED: Architecture violations detected."
  echo ""
  echo "   Violations detected:"
  echo "   - REWARD_HACK: expect(true) or meaningless tests"
  echo "   - MOCK_ABUSE: >3 mocks in single file"
  echo "   - CUSTOM_CONTRACT: Zod schema without TRL source"
  echo "   - SKIP_ABUSE: it.skip without TODO reason"
  echo ""
  echo "   Run 'npx tsx scripts/enforce-architecture.ts ./sandbox' for details."
  exit 1
}
echo "âœ… G4 PASSED"
echo ""

# Gate 5: V-PHASE REWARD HACKING DETECTOR (NEW - CRITICAL)
echo "ğŸ“‹ Gate 5/6: V-Phase Reward Hacking Detector..."
npx tsx scripts/v-phase-gate.ts --staged || {
  echo ""
  echo "âŒ G5 FAILED: REWARD HACKING DETECTED"
  echo ""
  echo "   A demo that doesn't use the architecture is NOT a demo."
  echo "   It's a spike that proves nothing."
  echo ""
  echo "   Common violations:"
  echo "   - Inline FSM instead of XState adapter"
  echo "   - Inline 1â‚¬ filter instead of OneEuroAdapter"
  echo "   - Direct DOM events instead of NATS substrate"
  echo "   - TODO stubs in production code"
  echo "   - 'For now' shortcuts that bypass architecture"
  echo ""
  exit 1
}
echo "âœ… G5 PASSED"
echo ""

# Gate 6: Contract TRL Lineage Check
echo "ğŸ“‹ Gate 6/6: TRL 9 Contract Lineage..."
# Check that contract files have @source or @see tags
CONTRACT_FILES=$(find ./sandbox -name "*.contract.ts" -o -name "*schema*.ts" 2>/dev/null | head -20)
if [ -n "$CONTRACT_FILES" ]; then
  MISSING_TRL=0
  for file in $CONTRACT_FILES; do
    if ! grep -q -E "@source|@see|TRL|W3C|CNCF|RFC" "$file" 2>/dev/null; then
      echo "   âš ï¸  Missing TRL lineage: $file"
      MISSING_TRL=$((MISSING_TRL + 1))
    fi
  done
  if [ $MISSING_TRL -gt 0 ]; then
    echo ""
    echo "âŒ G5 FAILED: $MISSING_TRL contract(s) missing TRL 9 lineage."
    echo "   Add JSDoc with @source URL pointing to standard (W3C, CNCF, RFC, etc.)"
    # Warning only for now, not blocking
    # exit 1
  fi
fi
echo "âœ… G5 PASSED"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… ALL 6 GATES PASSED - Commit approved                       â•‘"
echo "â•‘  Remember: Use HIVE commit prefixes (H: I: V: E:)             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
