#!/usr/bin/env sh

echo "üîí Pre-commit: Running machine validation..."

# Gate 1: TypeScript compilation
echo "  ‚Üí TypeCheck..."
npm run typecheck || exit 1

# Gate 2: Lint
echo "  ‚Üí Lint..."
npm run lint || exit 1

# Gate 3: Architecture smoke tests (run specific test file)
echo "  ‚Üí Architecture Smoke Tests..."
npx vitest run hot/silver/architecture.smoke.test.ts --passWithNoTests || exit 1

# Gate 4: Dependency boundaries (ALWAYS run - no conditional bypass)
echo "  ‚Üí Dependency Boundaries..."
npx dependency-cruiser --config hot/silver/.constraint-rules.mjs hot/silver || exit 1

# Gate 5: Folder whitelist (block unauthorized folders in hot/silver/)
echo "  ‚Üí Folder Whitelist..."
UNAUTHORIZED=$(find hot/silver -maxdepth 1 -type d ! -name "silver" ! -name "exemplars" ! -name "quarantine" 2>/dev/null | grep -v "^hot/silver$" || true)
if [ -n "$UNAUTHORIZED" ]; then
  echo "‚ùå BLOCKED: Unauthorized folders in hot/silver/:"
  echo "$UNAUTHORIZED"
  echo "Only 'exemplars/' and 'quarantine/' are allowed."
  exit 1
fi

echo "‚úÖ All gates passed. Commit allowed."
