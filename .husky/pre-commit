#!/usr/bin/env sh

echo "üîí Pre-commit: Running machine validation..."

# Gate 1: TypeScript compilation
echo "  ‚Üí TypeCheck..."
npm run typecheck || exit 1

# Gate 2: Lint
echo "  ‚Üí Lint..."
npm run lint || exit 1

# Gate 3: Architecture smoke tests (run specific test file)
echo "  ‚Üí Architecture Smoke Tests..."
npx vitest run hot/silver/architecture.smoke.test.ts --passWithNoTests || exit 1

# Gate 4: Dependency boundaries (ALWAYS run - no conditional bypass)
echo "  ‚Üí Dependency Boundaries..."
npx dependency-cruiser --config hot/silver/.constraint-rules.mjs hot/silver || exit 1

# Gate 5: Silver folder whitelist (only exemplars/ allowed now)
echo "  ‚Üí Silver Folder Whitelist..."
UNAUTHORIZED=$(find hot/silver -maxdepth 1 -type d ! -name "silver" ! -name "exemplars" 2>/dev/null | grep -v "^hot/silver$" || true)
if [ -n "$UNAUTHORIZED" ]; then
  echo "‚ùå BLOCKED: Unauthorized folders in hot/silver/:"
  echo "$UNAUTHORIZED"
  echo "Only 'exemplars/' is allowed. Quarantine goes in bronze."
  exit 1
fi

# Gate 6: Magic Numbers Provenance Check
echo "  ‚Üí Magic Numbers Provenance..."
# Check staged TS files for magic numbers without @source annotation
STAGED_TS=$(git diff --cached --name-only | grep -E '\.ts$' | grep -v '\.test\.ts$' | grep -v '\.spec\.ts$' | grep -v 'magic-numbers\.ts$' || true)
if [ -n "$STAGED_TS" ]; then
  MAGIC_VIOLATIONS=""
  for FILE in $STAGED_TS; do
    # Check for decimal literals like 0.007, 0.002 etc without nearby @source
    VIOLATIONS=$(git diff --cached "$FILE" | grep -E '^\+.*0\.[0-9]{2,}' | grep -v '@source\|@citation\|@see\|import.*magic-numbers' || true)
    if [ -n "$VIOLATIONS" ]; then
      MAGIC_VIOLATIONS="$MAGIC_VIOLATIONS\n$FILE:\n$VIOLATIONS"
    fi
  done
  if [ -n "$MAGIC_VIOLATIONS" ]; then
    echo "‚ö†Ô∏è  WARNING: Magic numbers detected without provenance:"
    echo -e "$MAGIC_VIOLATIONS"
    echo ""
    echo "   To fix:"
    echo "   1. Import from hot/bronze/src/constants/magic-numbers.ts"
    echo "   2. OR add @source JSDoc annotation"
    echo "   See: MAGIC_NUMBERS_REGISTRY.md"
    # Warning only for now - set to exit 1 to block
  fi
fi

# Gate 7: Single Entry Point - NEW code files must go to bronze/quarantine
echo "  ‚Üí Single Entry Point..."
NEW_CODE=$(git diff --cached --name-only --diff-filter=A | grep -E '\.(ts|tsx|js|jsx|html)$' | grep -v 'hot/bronze/quarantine/' | grep -v '\.test\.' | grep -v '\.spec\.' || true)
if [ -n "$NEW_CODE" ]; then
  echo "‚ùå BLOCKED: New code files must go to hot/bronze/quarantine/"
  echo "   Files blocked:"
  echo "$NEW_CODE"
  echo ""
  echo "   Medallion Architecture:"
  echo "   1. AI creates code ‚Üí hot/bronze/quarantine/ (ONLY entry point)"
  echo "   2. Pass machine gates ‚Üí promoted to hot/silver/exemplars/"
  echo "   3. Human approval ‚Üí promoted to hot/gold/"
  exit 1
fi

echo "‚úÖ All gates passed. Commit allowed."
