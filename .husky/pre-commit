#!/usr/bin/env sh

echo "üîí Pre-commit: Running machine validation..."

# Gate 1: TypeScript compilation
echo "  ‚Üí TypeCheck..."
npm run typecheck || exit 1

# Gate 2: Lint
echo "  ‚Üí Lint..."
npm run lint || exit 1

# Gate 3: Architecture smoke tests (run specific test file)
echo "  ‚Üí Architecture Smoke Tests..."
npx vitest run hot/silver/architecture.smoke.test.ts --passWithNoTests || exit 1

# Gate 4: Dependency boundaries (ALWAYS run - no conditional bypass)
echo "  ‚Üí Dependency Boundaries..."
npx dependency-cruiser --config hot/silver/.constraint-rules.mjs hot/silver || exit 1

# Gate 5: Silver folder whitelist (only exemplars/ allowed now)
echo "  ‚Üí Silver Folder Whitelist..."
UNAUTHORIZED=$(find hot/silver -maxdepth 1 -type d ! -name "silver" ! -name "exemplars" 2>/dev/null | grep -v "^hot/silver$" || true)
if [ -n "$UNAUTHORIZED" ]; then
  echo "‚ùå BLOCKED: Unauthorized folders in hot/silver/:"
  echo "$UNAUTHORIZED"
  echo "Only 'exemplars/' is allowed. Quarantine goes in bronze."
  exit 1
fi

# Gate 6: Magic Numbers Provenance Check
echo "  ‚Üí Magic Numbers Provenance..."
# Check staged TS files for magic numbers without @source annotation
STAGED_TS=$(git diff --cached --name-only | grep -E '\.ts$' | grep -v '\.test\.ts$' | grep -v '\.spec\.ts$' | grep -v 'magic-numbers\.ts$' || true)
if [ -n "$STAGED_TS" ]; then
  MAGIC_VIOLATIONS=""
  for FILE in $STAGED_TS; do
    # Check for decimal literals like 0.007, 0.002 etc without nearby @source
    VIOLATIONS=$(git diff --cached "$FILE" | grep -E '^\+.*0\.[0-9]{2,}' | grep -v '@source\|@citation\|@see\|import.*magic-numbers' || true)
    if [ -n "$VIOLATIONS" ]; then
      MAGIC_VIOLATIONS="$MAGIC_VIOLATIONS\n$FILE:\n$VIOLATIONS"
    fi
  done
  if [ -n "$MAGIC_VIOLATIONS" ]; then
    echo "‚ö†Ô∏è  WARNING: Magic numbers detected without provenance:"
    echo -e "$MAGIC_VIOLATIONS"
    echo ""
    echo "   To fix:"
    echo "   1. Import from hot/bronze/src/constants/magic-numbers.ts"
    echo "   2. OR add @source JSDoc annotation"
    echo "   See: MAGIC_NUMBERS_REGISTRY.md"
    # Warning only for now - set to exit 1 to block
  fi
fi

# Gate 7: Single Entry Point - NEW code files must go to bronze/quarantine
echo "  ‚Üí Single Entry Point..."
NEW_CODE=$(git diff --cached --name-only --diff-filter=A | grep -E '\.(ts|tsx|js|jsx|html)$' | grep -v 'hot/bronze/quarantine/' | grep -v '\.test\.' | grep -v '\.spec\.' || true)
if [ -n "$NEW_CODE" ]; then
  echo "‚ùå BLOCKED: New code files must go to hot/bronze/quarantine/"
  echo "   Files blocked:"
  echo "$NEW_CODE"
  echo ""
  echo "   Medallion Architecture:"
  echo "   1. AI creates code ‚Üí hot/bronze/quarantine/ (ONLY entry point)"
  echo "   2. Pass machine gates ‚Üí promoted to hot/silver/exemplars/"
  echo "   3. Human approval ‚Üí promoted to hot/gold/"
  exit 1
fi

echo "‚úÖ All fast gates passed."

# Gate 8: Pyre HIVE Sequence Scan (INFORMATIONAL - warnings only for now)
# TODO: Enable blocking after historical violations are cleared
echo "  ‚Üí Pyre HIVE Sequence Scan (INFO)..."
if command -v npx &> /dev/null; then
  npx --yes tsx scripts/pyre-daemon-runner.ts --scan-only 2>/dev/null || echo "  (Pyre scan skipped - tsx not available)"
fi

# Gate 9: Mutation Testing (80% threshold) - BLOCKING on changed files
# Only runs if TS files in hot/bronze/src are staged
echo "  ‚Üí Mutation Testing Check..."
STAGED_SRC=$(git diff --cached --name-only | grep -E '^hot/bronze/src/.*\.ts$' | grep -v '\.test\.ts$' | grep -v '\.spec\.ts$' || true)
if [ -n "$STAGED_SRC" ]; then
  echo "    Found staged source files - checking mutation score threshold..."
  
  # Check if stryker is available
  if command -v npx &> /dev/null; then
    # Run mutation testing on staged files only (faster)
    # Use break threshold of 80% - will exit 1 if below
    MUTATE_FILES=$(echo "$STAGED_SRC" | tr '\n' ',' | sed 's/,$//')
    
    echo "    Testing files: $MUTATE_FILES"
    
    # Run stryker with 80% break threshold
    # --coverageAnalysis perTest = only run relevant tests (fast)
    # --thresholds.break 80 = fail if score < 80%
    npx stryker run \
      --mutate "$MUTATE_FILES" \
      --coverageAnalysis perTest \
      --logLevel error \
      --reporters clear-text \
      --thresholds.break 80 2>&1 | tail -20
    
    STRYKER_EXIT=$?
    
    if [ $STRYKER_EXIT -ne 0 ]; then
      echo ""
      echo "‚ùå BLOCKED: Mutation score below 80% threshold"
      echo "   Your tests pass but don't catch enough mutations."
      echo "   This means your tests may not actually verify behavior."
      echo ""
      echo "   To fix:"
      echo "   1. Run: npx stryker run --mutate 'your/file.ts'"
      echo "   2. Look for 'Survived' mutants in output"
      echo "   3. Add tests that would catch those mutations"
      echo ""
      echo "   To skip (NOT RECOMMENDED):"
      echo "   git commit --no-verify"
      exit 1
    fi
    
    echo "    ‚úÖ Mutation score meets 80% threshold"
  else
    echo "    (Stryker skipped - npx not available)"
  fi
else
  echo "    (No staged source files - skipping mutation testing)"
fi

echo ""
echo "‚úÖ All gates passed. Commit allowed."
